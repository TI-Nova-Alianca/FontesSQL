SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[MERCP_LIBERACAO_PEDIDO](
@P_NRO		INT,
@P_EXCLUI	INT,
@P_USUARIO  VARCHAR(100),
@P_ACAO		INT,
@P_CODIGOJUSTIFICATIVA       VARCHAR(100) = NULL,
@P_OBSERVACAOJUSTIFICATIVA   VARCHAR(1024) = NULL,
@P_REPRESJUSTIFICATIVA       INT = NULL,
@P_STATUSPEDIDO              INT,
@P_MOTIVOREQUERJUSTIFICATIVA VARCHAR(10) OUT,
@P_ERROLIMVERBA              VARCHAR(255) OUT,
@P_RECALCULAMOTBLOQP         INT = 0,
@P_DATAS_CALCULADAS          VARCHAR(100) = ''
) AS
BEGIN
DECLARE @VDATA						DATETIME;
DECLARE @VERRO						VARCHAR(1000) = '';
DECLARE @VOBJETO		            VARCHAR(200) = 'MERCP_LIBERACAO_PEDIDO';
DECLARE @V_PASSO					VARCHAR(1000);
DECLARE @V_PED_CLIENTE				FLOAT;
DECLARE @V_CLI_CGCMF				VARCHAR(19);
DECLARE @V_CLI_VINCULO              FLOAT;
DECLARE @V_TOTAL_PEDIDOS_EM_ABERTO  FLOAT;
DECLARE @V_TOTAL_COBRANCA_CLIENTE   FLOAT;
DECLARE @V_TOTAL_LIMITE_DISP        FLOAT;
DECLARE @V_PARAM_AN_CRED            FLOAT;
DECLARE @V_CLI_DIASAMAIS            FLOAT  = 0;
DECLARE @V_MOTIVOS                  VARCHAR(15);
DECLARE @V_PARAM_TPDOC_AVAL         VARCHAR(50);
DECLARE @V_DIAS                     FLOAT;
DECLARE @V_DATA                     DATE;
DECLARE @V_CLIATRS                  FLOAT;
DECLARE @V_CLICRED                  FLOAT;
DECLARE @V_TOTAL_LIMITE_EXC         FLOAT;
DECLARE @V_PERMI                    VARCHAR(30);
DECLARE @V_CFE_VLR                  VARCHAR(30);
DECLARE @V_FLG_LIB_MOTIVO_A_ALCADA         FLOAT;
DECLARE @V_FLG_LIB_MOTIVO_A_PGTO	INT;
DECLARE @V_PED_COND_PGTO            FLOAT;
DECLARE @V_FLG                      FLOAT;
DECLARE @V_VLR_MAXATRS              FLOAT;
DECLARE @V_VLR_MAX                  FLOAT;
DECLARE @V_CLILIM                   FLOAT;
DECLARE @V_VLR_MAXLIM               FLOAT;
DECLARE @V_LIB_VLREXCLIM            FLOAT;
DECLARE @V_LIB_DIVTOTMAX            FLOAT;
DECLARE @V_LIB_DIVLIMMAX            FLOAT;
DECLARE @V_PRM_APLDESCTO            FLOAT;
DECLARE @V_PED_TOT                  FLOAT;
DECLARE @V_BON_TOT                  FLOAT;
DECLARE @V_BRUTO                    FLOAT;
DECLARE @V_ECON                     FLOAT;
DECLARE @V_PED_DCTOEXC              FLOAT;
DECLARE @V_PED_DCTO                 FLOAT;
DECLARE @V_VLR_PED                  FLOAT;
DECLARE @V_LIB_DCTMAX               FLOAT;
DECLARE @V_CPGTO_PRZTOT             FLOAT;
DECLARE @V_LIB_PRZMED_MAX           FLOAT;
DECLARE @V_LIB_PRZTOT_MAX           FLOAT;
DECLARE @V_CPGTO_PRZMED             FLOAT;
DECLARE @V_TBOPS_FAT                VARCHAR(1);
DECLARE @V_LIB_BONMAX               FLOAT
, @V_LIB_BONMAX_VLR           FLOAT;
DECLARE @V_BON_PERC                 FLOAT;
DECLARE @V_PARAM_AVALCONCEITOLUCR   FLOAT;
DECLARE @V_LUCRATIVIDADE            FLOAT;
DECLARE @V_USU_PERCMINIMO_LUCR      FLOAT;
DECLARE @V_LIBERA_PEDIDO            FLOAT;
DECLARE @V_LIB_LIMITEEXCEDIDO       FLOAT;
DECLARE @V_LIBMOTS                  VARCHAR(30)  = '';
DECLARE @V_BLQS                     VARCHAR(30)  = '';
DECLARE @V_BLQS_AUX					VARCHAR(30)	 = '';
DECLARE @V_LIBTOT                   FLOAT;
DECLARE @V_USUS                     VARCHAR(255);
DECLARE @V_DATAS                    VARCHAR(255);
DECLARE @V_HORAS                    VARCHAR(255);
DECLARE @V_GRUPO_LIB                FLOAT;
DECLARE @V_BLOQUEIOS                VARCHAR(30)='';
DECLARE @V_BLOQUEIOS_AUX			VARCHAR(30)='';
DECLARE @V_SITUACAO_CORPORATIVO     VARCHAR(10);
DECLARE @V_UPDATE_SITUACAO          FLOAT;
DECLARE @V_UPDATE_DTULTLIBERACAO    DATE;
DECLARE @V_LIBPARC                  FLOAT = 1;
DECLARE @V_CLI_RAMATIV              VARCHAR(5);
DECLARE @V_PED_EMPRESA              VARCHAR(3);
DECLARE @V_PED_TIPO                 VARCHAR(10);
DECLARE @V_CLI_CLASCOM              VARCHAR(15);
DECLARE @V_PED_SITCORP              VARCHAR(6);
DECLARE @V_CLI_REGIAOCOM            VARCHAR(8);
DECLARE @V_PED_OPERACAO             VARCHAR(6);
DECLARE @V_ALCP_CODIGO              VARCHAR(5);
DECLARE @V_ALCP_CODIGO_TEMP			VARCHAR(5);
DECLARE @V_ALCP_GRPALCADA           VARCHAR(12);
DECLARE @V_ULTIMO_USUARIO           VARCHAR(30);
DECLARE @V_ALCP_CODIGO_ANTERIOR     VARCHAR(5);
DECLARE @V_ALCP_GRPALCADA_ANTERIOR  VARCHAR(12)
, @V_ALCP_GRPLIB_ANTERIOR     INT
, @V_ALCP_NIVLIB_ANTERIOR     INT;
DECLARE @V_PEDAL_SEQ                SMALLINT;
DECLARE @V_EXISTE                   INT;
DECLARE @V_MOTNLIBERADO             VARCHAR(30);
DECLARE @V_ACHOU_OUTROMOTIVO        VARCHAR(30);
DECLARE @V_PARAM_MOTIVSLIBER        VARCHAR(15);
DECLARE @V_PED_REPRES               VARCHAR(9);
DECLARE @V_PED_MOTIVO_BLOQ          VARCHAR(15);
DECLARE @V_CODIGO_USUARIO           VARCHAR(40);
DECLARE @V_PED_SITUACAO_ATUAL       FLOAT;
DECLARE @V_ALCADA_OK                FLOAT;
DECLARE @V_ALCADA_ATUAL             VARCHAR(5);
DECLARE @V_PERMITE_ENCAMINHAR       FLOAT;
DECLARE @V_ULTIMO_GRUPO             SMALLINT;
DECLARE @V_GRUPO_ATUAL              SMALLINT;
DECLARE @V_PARAM_CRIT_CRED          VARCHAR(10)
DECLARE @V_AUX						INT;
DECLARE @V_AUX2						INT;
DECLARE @V_PED_LIB_MOTS				VARCHAR(100);
DECLARE @VDB_PRM_JUST_LIBPAR        VARCHAR(20);
DECLARE @VDB_PRM_JUST_LIBTOT        VARCHAR(20);
DECLARE @V_PODE_LIBERAR             INT;
DECLARE @V_PEDAL_MOTLIBPAR	        VARCHAR(20);
DECLARE @V_DESCRICAO                VARCHAR(100);
DECLARE @V_PROGRAMA                 VARCHAR(20);
DECLARE @V_PERMITE_LOG              BIT = 0;
DECLARE @V_SESSAO                   INT;
DECLARE @V_PARAM_VALOR              INT;
DECLARE @V_REGISTRA_ACOES           INT;
DECLARE @VDB_PRM_ATIVLOGUTIL        INT;
DECLARE @VSU1_ATIVLOGUTIL           INT;
DECLARE @V_PED_WEB                  INT;
DECLARE @V_PARAM_VAL_VALIDA         INT;
DECLARE @V_DB_CLI_ESTADO            VARCHAR(10);
DECLARE @V_DB_PED_EMPRESA			VARCHAR(3);
DECLARE @V_DB_PED_REPRES			VARCHAR(10);
DECLARE @V_DB_TBREP_UNIDFV			VARCHAR(3);
DECLARE @V_DB_PED_DT_EMISSAO		DATETIME;
DECLARE @V_DB_CLI_CODIGO			FLOAT;
DECLARE @V_DB_PED_MOTIVO_BLOQ		VARCHAR(15);
DECLARE @V_DB_PED_MOTIVO_BLOQ_ALL	CHAR(15);
DECLARE @V_DB_PED_OPERACAO			VARCHAR(6);
DECLARE @V_SEM_SALDO				BIT = 0;
DECLARE @V_VALOR_TOTAL				FLOAT;
DECLARE @V_RESTRICAO				VARCHAR(20);
DECLARE @V_FLAG						BIT;
DECLARE @V_DB_PROD_CODIGO			VARCHAR(16);
DECLARE @V_DB_PROD_TPPROD			VARCHAR(4);
DECLARE @V_DB_PEDI_OPERACAO			VARCHAR(10)
DECLARE @V_DB_PEDI_PRECO_LIQ		REAL;
DECLARE @V_DB_PEDI_QTDE_SOLIC		REAL;
DECLARE @V_DB_PEDI_QTDE_CANC		REAL;
DECLARE @V_DB_PEDI_SEQUENCIA		INT;
DECLARE @V_DB_RESBR_EMPRESA			VARCHAR(3);
DECLARE @V_DB_RESBR_REPRES			INT;
DECLARE @V_DB_RESBR_CLIENTE			FLOAT;
DECLARE @V_DB_RESBR_UNIDFV			VARCHAR(3);
DECLARE @V_DB_RESBR_TPPROD			VARCHAR(4);
DECLARE @V_DB_RESBR_OPER			VARCHAR(10);
DECLARE @V_DB_RESBR_EXCETO			SMALLINT;
DECLARE @V_DB_RESB_VLVERBA			FLOAT
DECLARE @V_DB_RESB_VLRUTISVN		FLOAT;
DECLARE @V_DB_RESB_CODIGO			VARCHAR(5);
DECLARE @V_DB_RESB_VUTIVERBA        FLOAT;
DECLARE @V_SAI                      BIT = 0;
DECLARE @V_SITUACAO					INT;
DECLARE @V_INTEGRA_PEDIDO			INT;
DECLARE @VDB_PED_DESCTO				FLOAT;
DECLARE @VDB_PED_DESCTO2			FLOAT;
DECLARE @VDB_PED_DESCTO3			FLOAT;
DECLARE @VDB_PED_DESCTO4			FLOAT;
DECLARE @VDB_PED_DESCTO5			FLOAT;
DECLARE @VDB_PED_DESCTO6			FLOAT;
DECLARE @VDB_PED_DESCTO7			FLOAT;
DECLARE @VDB_PEDI_DESCTOP           FLOAT;
DECLARE @VDB_ALCP_INDTOTDCTO        VARCHAR(10);
DECLARE @VDB_ALCP_TOTDCTO           FLOAT;
DECLARE @V_DESCTO_TOTAL             FLOAT;
DECLARE @V_ENV_WORKFLOW             INTEGER = 0;
DECLARE @VRETORNO                   VARCHAR(1000);
DECLARE @VDB_ALCP_ECONOMIA          FLOAT;
DECLARE @V_PARAM_VALDESCONTOEXCEDIDO INT;
DECLARE @VPEDIDO_TOTAL_ITEM         FLOAT;
DECLARE @VECONOMIA_ITEM             FLOAT;
DECLARE @VDB_ALCP_DESCTOMEDIO       FLOAT;
DECLARE @V_DESCONTO_ITEM            FLOAT;
DECLARE @V_VALOR_TEMP               FLOAT;
DECLARE @VDB_PEDI_PRECO_UNIT        FLOAT;
DECLARE @VDB_PEDI_QTDE_SOLIC        INT;
DECLARE @VDB_PEDI_QTDE_CANC         INT;
DECLARE @VPED_REGRAPERCENTUALECO    INT;
DECLARE @V_VALOR_BRUTO_ITEM         FLOAT;
DECLARE @V_POL_BONIMOTIVOBRIG_LIB    INT;
DECLARE @V_POL_INDDESCCABMOTDESOBRIG_LIB   VARCHAR(50);
DECLARE @V_VALIDA_DESCONTO           INT;
DECLARE @V_POL_INDDESCTOITMOTDESOBRIG_LIB  VARCHAR(50);
DECLARE @V_POL_DESCTOINVEST_LIB      INT;
DECLARE @V_MOTIVO_INVESTIMENTO        INT;
DECLARE @V_TEMP_COUNT                INT;
DECLARE @V_AVALIACAOLIMCREDITO      INT;
DECLARE @V_MOTNLIBERADOSALVARPEDIDO VARCHAR(30);
DECLARE @V_DB_CLIR_PRAZO_MAX          FLOAT;
DECLARE @V_LIB_PRZMEDEXCCLI           FLOAT;
DECLARE @V_VALOR_LIQ_TOTAL_DESCONTOS  FLOAT
, @V_VALOR_BRU_TOTAL            FLOAT
, @V_DESCONTO_MEDIO_PEDIDO      FLOAT;
DECLARE @V_SOLICITACAO_BLOQUEADA      INT;
DECLARE @V_VERIFICA_MOTIVO_BLOQ78     INT;
DECLARE @V_JSON						  VARCHAR(MAX);
DECLARE @V_URL						  VARCHAR(150);
DECLARE @VPOINTER					  INT;
DECLARE @VRESPONSETEXT				  VARCHAR(8000);
DECLARE @VSTATUS					  INT;
DECLARE @VSTATUSTEXT				  VARCHAR(200);
DECLARE @UNWRAPPEDXML				  NVARCHAR(4000);
DECLARE @V_ALCP_AVALIADESCONTO        SMALLINT;
DECLARE @V_ITEM_DSCTO_0               FLOAT;
DECLARE @V_ITEM_DSCTO_1               FLOAT;
DECLARE @V_ITEM_DSCTO_2               FLOAT;
DECLARE @V_ITEM_DSCTO_3               FLOAT;
DECLARE @V_ITEM_DSCTO_4               FLOAT;
DECLARE @V_ITEM_DSCTO_5               FLOAT
, @V_ITEM_DSCTO_6               FLOAT
, @V_ITEM_DSCTO_7               FLOAT
, @V_ITEM_DSCTO_8               FLOAT
, @V_ITEM_DSCTO_9               FLOAT
, @V_ITEM_DSCTO_10              FLOAT
DECLARE @V_PED_DSCTO				FLOAT;
DECLARE @V_PED_DSCTO2			    FLOAT;
DECLARE @V_PED_DSCTO3			    FLOAT;
DECLARE @V_PED_DSCTO4			    FLOAT;
DECLARE @V_PED_DSCTO5			    FLOAT;
DECLARE @V_PED_DSCTO6			    FLOAT;
DECLARE @V_PED_DSCTO7			    FLOAT;
DECLARE @V_ALCP_INDICEDESCITEM        VARCHAR(50);
DECLARE @V_ALCP_REGRAEXCDESCONTO      FLOAT;
DECLARE @V_DESCTO_ITEM_REGRA          FLOAT;
DECLARE @V_ALCP_TIPOAVALIADESCONTO    SMALLINT;
DECLARE @V_LIB_DCTMAX_ITEM            FLOAT;
DECLARE @V_PED_DCTO_ITEM              FLOAT;
DECLARE @V_CODIGO_PRODUTO			  VARCHAR(16);
DECLARE @V_TIPO						  VARCHAR(4);
DECLARE @V_MARCA					  VARCHAR(4);
DECLARE @V_FAMILIA					  VARCHAR(8);
DECLARE @V_GRUPO					  VARCHAR(8);
DECLARE @V_SEQ_ITEM                   INT;
DECLARE @VDB_PEDD_DESCONTO            FLOAT;
DECLARE @VDB_PEDD_INDDESCTO           INT;
DECLARE @V_PRECO_POLITICA             FLOAT;
DECLARE @V_PRECO_APLICADO             FLOAT;
DECLARE @V_PRECO_BRUTO_UNIT           FLOAT;
DECLARE @V_QUANTIDADE_ITEM_ECON       FLOAT;
DECLARE @VPED_NRODESCTOITEM           INT;
DECLARE @V_STATUS_PED                 INT;
DECLARE @V_STATUS_PED_ATUAL           INT;
DECLARE @V_STATUS_VALIDO              INT;
DECLARE @V_PERCENTUAL_MAXIMO_REDUCAO  FLOAT;
DECLARE @V_TIPO_AGRUPAMENTO           INT;
DECLARE @V_FATURAMENTO_LIQUIDO		  FLOAT;
DECLARE @V_VALOR_IMPOSTOS			  FLOAT;
DECLARE @V_VALOR_FRETE				  FLOAT;
DECLARE @V_PESO_BRUTO				  FLOAT;
DECLARE @V_AGRUPAMENTO				  VARCHAR(50);
DECLARE @V_VALOR_AGRUPAMENTO_MINIMO   VARCHAR(50);
DECLARE @VDB_PEDM_AGRUPAMENTO		  VARCHAR(100);
DECLARE @VDB_PEDM_VALOR_AGRUPAMENTO   VARCHAR(100);
DECLARE @V_COUNT_AGRUPAMENTOS		  INT;
DECLARE @V_NUMERO_AGRUPAMENTOS		  INT;
DECLARE @V_TOTAL_AGRUPAMENTO          FLOAT;
DECLARE @V_SEQ_DOC                    INT;
DECLARE @V_EXISTE_DOC_BLOQ			  INT;
DECLARE @DB_ALCP_LSTTIPODOC           VARCHAR(1052);
DECLARE @V_LIB_BLOQXDEBITOCONTA       INT
, @V_DB_PEDC_CONTAINV_SUP       FLOAT
, @V_VALOR_LANCAMENTO           FLOAT
DECLARE @V_SEQ_LANCAMENTOS            BIGINT
DECLARE @V_ACRESCIMO_PEDIDO           FLOAT;
DECLARE @V_ACRESCIMO_PEDIDO_POL       FLOAT;
DECLARE @V_ACRESCIMO_ITEM             FLOAT;
DECLARE @V_DB_PEDD_TPDESC             FLOAT;
DECLARE @V_DB_PEDI_ACRESCIMO          FLOAT;
DECLARE @V_DB_PED_LISTA_PRECO		  VARCHAR(50);
DECLARE @V_INDICE_DESCTO_FINANCEIRO   INT;
DECLARE @V_PRECO_APLICADO_TOTAL       FLOAT;
DECLARE @V_PRECO_TOTAL_POLITICA       FLOAT;
DECLARE @V_ECONOMIA_ITEM              FLOAT;
DECLARE @V_SEQ_ITEM_BLOQ_K            INT;
DECLARE @V_DESCONTO_APLICADO          FLOAT;
DECLARE @V_DESCONTO_CALCULADO         FLOAT;
DECLARE @V_VALOR_BASE                 FLOAT;
DECLARE @V_PRECO_LIQUIDO_K            FLOAT;
DECLARE @V_PRECO_BRUTO_K              FLOAT;
DECLARE @V_QUANTIDADE_K               INT;
DECLARE @V_BASE_DESCTO_FINANCEIRO     INT;
DECLARE @V_PRECO_COM_IMPOSTOS_K       FLOAT;
DECLARE @V_VALOR_INIT_DESC_FINAN      FLOAT;
DECLARE @VDB_ALCP_DCTOMAXVERBA		  FLOAT;
DECLARE @VDB_ALCP_VLRMAXTPPED         FLOAT;
DECLARE @VLIB_GRAVAJUSTIFICATIVAPED   INT;
DECLARE @V_TEMP_MOT_LIB_TOT           VARCHAR(30);
DECLARE @V_CLI_AREAATU				  VARCHAR(3);
DECLARE @V_USUARIO_PARA_LOG           VARCHAR(50)
DECLARE @V_COMPLEMENTO_LOG            VARCHAR(800)
DECLARE @V_DB_ALCP_DCTOMAXJUSTIF     FLOAT;
DECLARE @V_DESCONTO_PED_ITEM         FLOAT;
DECLARE @V_EXIGE_JUSTIFICATIVA_MOT_D INT;
DECLARE @V_PED_RECALCULAMOTBLOQP     INT;
DECLARE @V_DATA3					 DATE;
DECLARE @VDB_PED_DT_PREVENT			 DATE;
DECLARE @VDB_PED_DT_PRODUC			 DATE;
DECLARE @VDB_PEDC_PREV_FAT           DATE;
DECLARE @V_PERCMINIMO_LUCR_ITEM      FLOAT;
DECLARE @V_FORMA_AVALIA_LUCRA		 INT;
DECLARE @V_VALIDA_BLOQ_93			 INT;
DECLARE @V_LIMPA_BLOQ_L_ITENS       INT;
DECLARE @V_LIMPA_BLOQ_L_PEDIDO      INT;
DECLARE @VDB_PEDC_BLOQLUC            INT;
DECLARE @V_GRAVALOG                  INT;
SET NOCOUNT ON;
BEGIN TRANSACTION
SET @V_GRAVALOG = 0
SELECT @V_GRAVALOG = DB_PRMS_VALOR
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'MERCP_GRAVALOG'
IF @V_GRAVALOG = 1
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR) + ' - Inicia liberacao')
END
SELECT @V_SITUACAO = DB_PED_SITUACAO
FROM DB_PEDIDO
WHERE DB_PED_NRO = @P_NRO;
IF @V_SITUACAO = 0
BEGIN
IF @V_GRAVALOG = 1
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR) + ' - Sai procedure situacao = 0');
COMMIT;
END
RETURN;
END
SELECT @V_INTEGRA_PEDIDO = DB_TBTPE_NEXPCORP
FROM DB_PEDIDO
INNER JOIN DB_TB_TPPEDIDO ON DB_TBTPE_CODIGO   = DB_PED_TIPO
AND DB_TBTPE_NEXPCORP = 1
WHERE DB_PED_NRO = @P_NRO;
IF @V_INTEGRA_PEDIDO <> 0
BEGIN
DELETE FROM DB_PEDIDO_ALCADA WHERE DB_PEDAL_PEDIDO = @P_NRO;
IF @V_GRAVALOG = 1
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR) + ' - Sai procedure v_integra_pedido = 1');
COMMIT;
END
RETURN;
END
SELECT @V_PROGRAMA = PROGRAM_NAME FROM SYS.DM_EXEC_SESSIONS WHERE SESSION_ID = @@SPID
IF (SUBSTRING(@V_PROGRAMA,CHARINDEX('Internet',@V_PROGRAMA), LEN('Internet'))) = 'Internet'
BEGIN
SET @V_PROGRAMA = '[MercanetWEB]';
SET @V_PED_WEB = 1;
SELECT @V_PARAM_VALOR = DB_PRMS_VALOR
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'REGISTRA_ACOES';
IF @V_PARAM_VALOR = 1
SET @V_PERMITE_LOG = 1
ELSE IF @V_PARAM_VALOR = 2
BEGIN
SELECT @V_REGISTRA_ACOES = REGISTRA_ACOES
FROM DB_USUARIO
WHERE USUARIO = @P_USUARIO;
IF @V_REGISTRA_ACOES = 1
SET @V_PERMITE_LOG = 1;
END
END
ELSE
BEGIN
SET @V_PROGRAMA = '[Server]';
SELECT @VDB_PRM_ATIVLOGUTIL = DB_PRM_ATIVLOGUTIL  FROM DB_PARAMETRO
IF @VDB_PRM_ATIVLOGUTIL = 1
SET @V_PERMITE_LOG = 1;
ELSE IF @VDB_PRM_ATIVLOGUTIL = 2
BEGIN
SELECT @VSU1_ATIVLOGUTIL = SU1_ATIVLOGUTIL FROM MSU1 WHERE SU1_USUARIO = @P_USUARIO
IF @VSU1_ATIVLOGUTIL = 1
SET @V_PERMITE_LOG = 1;
END
END
SET @V_PARAM_VAL_VALIDA = 0
SELECT @V_PARAM_VAL_VALIDA = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'PED_VALIDARESTRICAOBONI';
SET @V_PED_RECALCULAMOTBLOQP = 0
SELECT @V_PED_RECALCULAMOTBLOQP = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'PED_RECALCULAMOTBLOQP';
BEGIN TRY
IF @P_ACAO = 4
BEGIN
IF ISNULL(@P_USUARIO, '') = ''
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES ('USUÁRIO NÃO INFORMADO', GETDATE(), @VOBJETO);
COMMIT;
RETURN;
END
BEGIN
SELECT @V_CODIGO_USUARIO = CODIGO
FROM DB_USUARIO
WHERE USUARIO = @P_USUARIO;
IF ISNULL(@V_CODIGO_USUARIO, '') = ''
BEGIN
SET @VDATA = GETDATE();
SET @VERRO = 'PEDIDO ' + CAST(@P_NRO AS VARCHAR) + ' NÃO FOI POSSIVEL ENCONTRAR USUARIO DE LIBERACAO: ' + @P_USUARIO + ' ';
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
COMMIT;
RETURN;
END
END
IF ISNULL(@P_USUARIO, '') <> ''
BEGIN
SELECT @V_ALCADA_ATUAL = DB_PEDAL_ALCADA
FROM DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO
AND DB_PEDAL_STATUS = 0;
IF ISNULL(@V_ALCADA_ATUAL, '') <> ''
BEGIN
SET @V_ALCADA_OK = 0
SELECT @V_ALCADA_OK = 1
FROM DB_ALCADA_USUARIO, DB_ALCADA_PED
WHERE DB_ALCU_ALCADA = @V_ALCADA_ATUAL
AND DB_ALCU_USUARIO = @V_CODIGO_USUARIO
AND DB_ALCP_CODIGO = DB_ALCU_ALCADA
AND DB_ALCP_REJEITA <> 0;
END
END
ELSE
BEGIN
SET @V_ALCADA_OK = 0;
END
IF @V_ALCADA_OK  <> 1
BEGIN
SET @VDATA = GETDATE();
SET @VERRO = 'PEDIDO ' + CONVERT(VARCHAR, @P_NRO) + ' ESTA TENTANTO SER REJEITADO POR UM USUARIO QUE NAO PERTENCE A ALCADA ATUAL, OU A ALÇADA NÃO PERTIME REJEIÇÃO. USUARIO ' +  @P_USUARIO + ' ALCADA ATIUAL ' + @V_ALCADA_ATUAL;
INSERT INTO DBS_ERROS_TRIGGERS(DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
IF @V_GRAVALOG = 1
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR)
+ ' - Sai procedure: esta tentando ser rejeitado por um usuario que nao pertencente a alcada atual, ou a alçada não pertime rejeição. Usuario:');
END
COMMIT;
RETURN;
END
IF @V_ALCADA_OK = 1
BEGIN
SELECT @V_STATUS_PED_ATUAL = DB_PEDC_STATUSPED,
@V_PED_REPRES = DB_PED_REPRES,
@V_PED_CLIENTE = DB_PED_CLIENTE,
@V_PED_EMPRESA = DB_PED_EMPRESA
FROM DB_PEDIDO
, DB_PEDIDO_COMPL
WHERE DB_PED_NRO = DB_PEDC_NRO
AND DB_PED_NRO = @P_NRO;
INSERT INTO DB_MENSAGEM (
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_PEDIDO,
DB_MSG_TEXTO,
DB_MSG_MOTIVO_REJEICAO,
DB_MSG_ALCADA_REJEICAO
)
VALUES (
@V_PED_REPRES,
ISNULL((SELECT MAX(DB_MSG_SEQUENCIA) FROM DB_MENSAGEM WHERE DB_MSG_REPRES = @V_PED_REPRES), 0) + 1,
GETDATE(),
@P_USUARIO,
@P_NRO,
'Pedido rejeitado. Motivo: '
+ ISNULL((SELECT DESCRICAO FROM DB_MOTIVO_REJEICAO WHERE CODIGO = @P_CODIGOJUSTIFICATIVA), '')
+ '. ' + @P_OBSERVACAOJUSTIFICATIVA +
'. Novo status do pedido: ' +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @P_STATUSPEDIDO), '[SEM STATUS]') +
'. Status anterior: '  +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED_ATUAL), '[SEM STATUS]'),
@P_CODIGOJUSTIFICATIVA ,
@V_ALCADA_ATUAL
);
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED     = @P_STATUSPEDIDO,
DB_PEDC_DATA_ALTERWEB = GETDATE()
WHERE DB_PEDC_NRO = @P_NRO;
UPDATE DB_PEDIDO
SET DB_PED_DATA_ENVIO = NULL
WHERE DB_PED_NRO = @P_NRO;
COMMIT;
SET @V_DESCRICAO = @V_PROGRAMA +
' Rejeitou pedido. Pedido nro: ' +
CAST(@P_NRO AS VARCHAR);
IF (@V_PERMITE_LOG = 1) AND (ISNULL(@P_USUARIO, '') <> '')
BEGIN
IF @V_PED_WEB = 1
BEGIN
INSERT INTO MSL1
(SL1_DATA,
SL1_USUARIO,
SL1_MENU,
SL1_ITEM_MENUWEB,
SL1_ACAO,
SL1_DESCRICAO)
VALUES
(GETDATE(), @P_USUARIO, 0, 'Liberação de pedidos', 4, @V_DESCRICAO);
END
ELSE
BEGIN
INSERT INTO MSL1
(SL1_DATA,
SL1_USUARIO,
SL1_MENU,
SL1_MENUITEM,
SL1_ACAO,
SL1_DESCRICAO)
VALUES
(GETDATE(), @P_USUARIO, 0, 'Liberação de pedidos', 4, @V_DESCRICAO);
END
END
BEGIN
EXEC DBO.MERCP_LIBERACAO_PEDIDO @P_NRO,
1,
NULL,
1,
NULL,
NULL,
NULL,
0,
@VRETORNO ,
@VRETORNO
END
BEGIN
EXEC DBO.MERCP_WORKFLOW 140,
@V_PED_CLIENTE,
@P_NRO,
@V_PED_EMPRESA,
NULL,
NULL,
NULL,
NULL,
@P_USUARIO,
VRETORNO
END
END
RETURN
END
SET @VDATA = GETDATE();
SET @P_MOTIVOREQUERJUSTIFICATIVA = ''
SET @V_DESCONTO_PED_ITEM = 0
IF ISNULL(@P_USUARIO, '') <> ''
BEGIN
SELECT @V_CODIGO_USUARIO = CODIGO
FROM DB_USUARIO
WHERE USUARIO = @P_USUARIO;
IF ISNULL(@V_CODIGO_USUARIO, '') = ''
BEGIN
SET @VDATA = GETDATE();
SET @VERRO = 'PEDIDO ' + CONVERT(VARCHAR, @P_NRO) + ' NÃO FOI POSSIVEL ENCONTRAR USUARIO DE LIBERACAO: ' + @P_USUARIO + ' ';
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
END
END
SET @V_PASSO = '0';
IF @P_EXCLUI = 1
BEGIN
DELETE DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO;
UPDATE DB_PEDIDO
SET DB_PED_LIB_MOTS     = ''
, DB_PED_LIB_USUS     = ''
, DB_PED_LIB_DATAS	   = ''
WHERE DB_PED_NRO = @P_NRO;
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_LIB_HORAS  = ''
WHERE DB_PEDC_NRO  = @P_NRO;
BEGIN TRY
DELETE FROM DB_CC_LANCAMENTOS
WHERE DB_CC_LANCAMENTOS.PEDIDO = @P_NRO
AND EXISTS (SELECT 1
FROM DB_CC_CONTA_CORRENTE        CC
, DB_CI_CONTA_INVESTIMENTO    CI
WHERE DB_CC_LANCAMENTOS.CONTA_CORRENTE      = CC.CONTA_CORRENTE
AND CC.CONTA_INVESTIMENTO    = CI.CODIGO
AND CI.TIPO = 1)
END TRY
BEGIN CATCH
SET @VDATA = GETDATE();
SET @VERRO = 'PEDIDO :' + CONVERT(VARCHAR, @P_NRO) + ' nao foi possivel elimnar lancamentos de debito do pedido. ' + ERROR_MESSAGE();
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
END CATCH
END
SET @V_PASSO = '1';
SET @V_PED_CLIENTE = NULL;
SELECT
@V_PED_CLIENTE			= DB_PED_CLIENTE
, @V_MOTIVOS				= REPLACE(DB_PED_MOTIVO_BLOQ, ' ', '')
, @V_PED_MOTIVO_BLOQ		= REPLACE(DB_PED_MOTIVO_BLOQ, ' ', '')
, @V_DB_PED_MOTIVO_BLOQ_ALL = DB_PED_MOTIVO_BLOQ
, @V_CLI_CGCMF			= DB_CLI_CGCMF
, @V_CLI_VINCULO			= DB_CLI_VINCULO
, @V_CLI_DIASAMAIS		= DB_CLIC_DD_CPGTO
, @V_PED_COND_PGTO		= DB_PED_COND_PGTO
, @V_CLILIM				= DB_CLI_LIM_CREDAP
, @V_PRM_APLDESCTO		= DB_TBEMP_APLDCTO
, @V_TBOPS_FAT			= DB_TBOPS_FAT
, @V_LUCRATIVIDADE		= DB_PEDC_PERC_MLUCR
, @V_BLQS					= DB_PED_LIB_MOTS
, @V_USUS					= DB_PED_LIB_USUS
, @V_DATAS				= DB_PED_LIB_DATAS
, @V_HORAS				= DB_PEDC_LIB_HORAS
, @V_BLOQUEIOS			= DB_PED_LIB_MOTS
, @V_SITUACAO_CORPORATIVO = DB_PED_SITCORP
, @V_UPDATE_SITUACAO		= DB_PED_SITUACAO
, @V_UPDATE_DTULTLIBERACAO = DB_PEDC_DTULTLIB
, @V_CLI_RAMATIV			= DB_CLI_RAMATIV
, @V_PED_EMPRESA			= DB_PED_EMPRESA
, @V_PED_TIPO				= DB_PED_TIPO
, @V_CLI_CLASCOM			= DB_CLI_CLASCOM
, @V_PED_SITCORP			= DB_PED_SITCORP
, @V_CLI_REGIAOCOM		= DB_CLI_REGIAOCOM
, @V_PED_OPERACAO			= DB_PED_OPERACAO
, @V_ULTIMO_USUARIO		= DB_PED_LIB_USUS
, @V_PED_REPRES			= DB_PED_REPRES
, @V_PED_SITUACAO_ATUAL   = DB_PED_SITUACAO
, @V_PED_LIB_MOTS			= DB_PED_LIB_MOTS
, @V_STATUS_PED_ATUAL     = DB_PEDC_STATUSPED
, @V_DB_PEDC_CONTAINV_SUP = DB_PEDC_CONTAINV_SUP
, @V_DB_PED_LISTA_PRECO   = DB_PED_LISTA_PRECO
, @V_CLI_AREAATU          = DB_CLIC_AREAATU
, @VDB_PED_DT_PREVENT		= DB_PED_DT_PREVENT
, @VDB_PED_DT_PRODUC		= DB_PED_DT_PRODUC
, @VDB_PEDC_PREV_FAT		= DB_PEDC_PREV_FAT
, @V_DB_PED_DT_EMISSAO    = DB_PED_DT_EMISSAO
, @VDB_PEDC_BLOQLUC       = DB_PEDC_BLOQLUC
FROM DB_TB_EMPRESA, DB_PEDIDO, DB_PEDIDO_COMPL, DB_TB_OPERS, DB_CLIENTE
LEFT JOIN DB_CLIENTE_COMPL ON DB_CLI_CODIGO   = DB_CLIC_COD
WHERE DB_PED_NRO      = @P_NRO
AND DB_TBEMP_CODIGO = DB_PED_EMPRESA
AND DB_PED_NRO      = DB_PEDC_NRO
AND DB_PED_CLIENTE  = DB_CLI_CODIGO
AND DB_PED_OPERACAO = DB_TBOPS_COD;
SET @V_BLQS = '';
SET @V_BLOQUEIOS = '';
SET @VLIB_GRAVAJUSTIFICATIVAPED = 0
SELECT @VLIB_GRAVAJUSTIFICATIVAPED =	DB_PRMS_VALOR
FROM DB_PARAM_SISTEMA
WHERE DB_PARAM_SISTEMA.DB_PRMS_ID = 'LIB_GRAVAJUSTIFICATIVAPED'
DECLARE C_BLOQ_LIB CURSOR
FOR SELECT DB_PEDAL_MOTLIB, DB_PEDAL_MOTLIB
FROM DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO
OPEN C_BLOQ_LIB
FETCH NEXT FROM C_BLOQ_LIB
INTO @V_BLQS_AUX, @V_BLOQUEIOS_AUX
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_BLQS = ISNULL(@V_BLQS, '') + ISNULL(@V_BLQS_AUX, '')
SET @V_BLOQUEIOS = ISNULL(@V_BLOQUEIOS, '') + ISNULL(@V_BLOQUEIOS_AUX, '')
FETCH NEXT FROM C_BLOQ_LIB
INTO @V_BLQS_AUX, @V_BLOQUEIOS_AUX
END
CLOSE C_BLOQ_LIB
DEALLOCATE C_BLOQ_LIB
IF @V_UPDATE_SITUACAO <> 1
BEGIN
SET @VDATA = GETDATE();
SET @VERRO = 'PEDIDO ' + CONVERT(VARCHAR, @P_NRO) + ' JA ENCONTRA-SE LIBERADO. USUARIO ' + @P_USUARIO;
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
END;
IF ISNULL(@P_USUARIO, '') <> ''
BEGIN
SELECT @V_ALCADA_ATUAL = DB_PEDAL_ALCADA
FROM DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO
AND DB_PEDAL_STATUS = 0;
IF ISNULL(@V_ALCADA_ATUAL, '') <> ''
BEGIN
SET @V_ALCADA_OK = 0
SELECT @V_ALCADA_OK = 1
FROM DB_ALCADA_USUARIO
WHERE DB_ALCU_ALCADA = @V_ALCADA_ATUAL
AND DB_ALCU_USUARIO = @V_CODIGO_USUARIO
END
END
ELSE
BEGIN
SET @V_ALCADA_OK = 1;
END
IF @V_ALCADA_OK  <> 1
BEGIN
SET @VDATA = GETDATE();
SET @VERRO = 'PEDIDO ' + CONVERT(VARCHAR, @P_NRO) + ' ESTA TENTANTO SER LIBERADOO POR UM USUARIO QUE NAO PERTENCE A ALCADA ATUAL. USUARIO ' +  @P_USUARIO + ' ALCADA ATIUAL ' + @V_ALCADA_ATUAL;
INSERT INTO DBS_ERROS_TRIGGERS(DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
END
IF ISNULL(@V_PED_CLIENTE, '') <> ''
AND @V_PED_SITUACAO_ATUAL = 1 AND @V_ALCADA_OK = 1
BEGIN
SET @V_PASSO = 2;
IF @P_ACAO = 2
BEGIN
SET @V_ULTIMO_USUARIO = @P_USUARIO;
END
BEGIN
SET @V_PED_TOT = 0;
SET @V_BON_TOT = 0;
SELECT @V_PED_TOT = SUM(DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_LIQ),
@V_BRUTO =   SUM(DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_UNIT),
@V_ECON =    SUM(DB_PEDI_QTDE_SOLIC * DB_PEDI_ECON_VLR)
FROM DB_PEDIDO_PROD,   DB_PRODUTO
WHERE DB_PEDI_PEDIDO =  @P_NRO
AND DB_PEDI_PRODUTO = DB_PROD_CODIGO
AND DB_PEDI_TIPO NOT IN ('B', 'T');
SELECT @V_BON_TOT = SUM(DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_LIQ)
FROM DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PEDIDO = @P_NRO
AND DB_PEDI_PRODUTO = DB_PROD_CODIGO
AND DB_PEDI_TIPO IN ('B');
END
SET @V_PASSO = 3;
BEGIN
SET @V_PARAM_AN_CRED = 0;
SELECT @V_PARAM_AN_CRED				= ISNULL(DB_PRM_AN_CRED, 0),
@V_PARAM_TPDOC_AVAL		    = DB_PRM_TPDOC_AVAL,
@V_DIAS						= (DB_PRM_DD_CREDITO * - 1),
@V_DATA						= DB_PRM_DATA_POSCR,
@V_PARAM_AVALCONCEITOLUCR	= ISNULL(DB_PRM_AVCONCLUCR, 0),
@V_PARAM_MOTIVSLIBER			= DB_PRM_MOT_SLIBER,
@V_PARAM_CRIT_CRED			= DB_PRM_CRIT_CRED,
@VDB_PRM_JUST_LIBPAR		    = DB_PRM_JUST_LIBPAR,
@VDB_PRM_JUST_LIBTOT	        = DB_PRM_JUST_LIBTOT
FROM DB_PARAMETRO P, DB_PARAMETRO1 P1
WHERE P.DB_PRM_CHAVE = P1.DB_PRM1_CHAVE;
END
SET @V_PASSO = 4;
BEGIN
IF @V_PRM_APLDESCTO = 0
BEGIN
IF @V_PED_TOT > 0
SET @V_PED_DCTOEXC = @V_ECON * 100 / @V_PED_TOT;
ELSE
IF @V_BRUTO > 0
SET @V_PED_DCTOEXC = @V_ECON * 100 / @V_BRUTO;
END
SET @V_PED_DCTO = @V_PED_DCTOEXC;
SET @V_VLR_PED = @V_PED_TOT;
IF @V_PED_TOT > 0
SET @V_BON_PERC = (@V_BON_TOT * 100) / @V_PED_TOT;
ELSE
SET @V_BON_PERC = 0;
END
SET @V_PASSO = 5;
BEGIN
SELECT @V_PERMI =				DB_ALCP_MOTBLOQ,
@V_CFE_VLR =				DB_ALCP_MOTCFEVLR,
@V_FLG_LIB_MOTIVO_A_ALCADA =	DB_ALCP_LIBCPGTO,
@V_VLR_MAX =				DB_ALCP_VLRMAXLIB,
@V_VLR_MAXATRS =			DB_ALCP_LIMATRPGTO,
@V_LIB_DIVTOTMAX =		DB_ALCP_DIVTOTMAX,
@V_LIB_VLREXCLIM =		DB_ALCP_VLRCREDEXC,
@V_VLR_MAXLIM =			DB_ALCP_LIMCREDEX,
@V_LIB_DIVLIMMAX =		DB_ALCP_DIVLIMMAX,
@V_LIB_DCTMAX =			DB_ALCP_DCTMAXEXC,
@V_LIB_PRZMED_MAX =		DB_ALCP_PRZMEDMAX,
@V_LIB_PRZTOT_MAX =		DB_ALCP_PRZTOTMAX,
@V_LIB_BONMAX =		    DB_ALCP_PERCBONMAX,
@V_LIB_BONMAX_VLR =      ISNULL(DB_ALCP_VLRMAXBON, 0),
@V_USU_PERCMINIMO_LUCR = DB_ALCP_PERCMINLUC,
@V_LIBERA_PEDIDO =		DB_ALCP_TIPOVLRLIB,
@V_LIB_LIMITEEXCEDIDO =  DB_ALCP_LEXCVMAX,
@V_GRUPO_LIB =			DB_ALCP_GRUPOLIB,
@VDB_ALCP_INDTOTDCTO   = DB_ALCP_INDTOTDCTO,
@VDB_ALCP_TOTDCTO  	  = DB_ALCP_TOTDCTO,
@VDB_ALCP_ECONOMIA     = DB_ALCP_ECONOMIA,
@VDB_ALCP_DESCTOMEDIO  = DB_ALCP_DESCTOMEDIO,
@V_LIB_PRZMEDEXCCLI    = DB_ALCP_PRZMEDEXCCLI,
@V_ALCP_AVALIADESCONTO = DB_ALCP_AVALIADESCONTO,
@V_ALCP_TIPOAVALIADESCONTO  = DB_ALCP_TIPOAVALIADESCONTO,
@V_ALCP_REGRAEXCDESCONTO  = DB_ALCP_REGRAEXCDESCONTO,
@V_ALCP_INDICEDESCITEM   =  DB_ALCP_INDICEDESCITEM,
@V_PERCENTUAL_MAXIMO_REDUCAO = DB_ALCP_PMENORPMTON ,
@DB_ALCP_LSTTIPODOC	    = DB_ALCP_LSTTIPODOC,
@VDB_ALCP_DCTOMAXVERBA   = DB_ALCP_DCTOMAXVERBA,
@VDB_ALCP_VLRMAXTPPED    = ISNULL(DB_ALCP_VLRMAXTPPED, 0),
@V_DB_ALCP_DCTOMAXJUSTIF = DB_ALCP_DCTMAXJUSTIF,
@V_PERCMINIMO_LUCR_ITEM  = DB_ALCP_PERCMINLUCIT,
@V_FORMA_AVALIA_LUCRA    = ISNULL(DB_ALCP_AVALIALUC, 0)
FROM DB_ALCADA_PED, DB_ALCADA_USUARIO
WHERE DB_ALCP_CODIGO = DB_ALCU_ALCADA
AND DB_ALCP_CODIGO = @V_ALCADA_ATUAL
AND DB_ALCU_USUARIO = @V_CODIGO_USUARIO;
END
BEGIN
SET @V_FLG_LIB_MOTIVO_A_PGTO = 0;
SELECT @V_FLG_LIB_MOTIVO_A_PGTO = ISNULL(DB_TBPGTO_BLOQPED, 0)
FROM DB_TB_CPGTO
WHERE DB_TBPGTO_COD = @V_PED_COND_PGTO;
END
SET @V_PASSO = 6;
IF ISNULL(@P_USUARIO, '') <> '' AND @P_ACAO = 1
BEGIN
SET @V_PASSO = 7;
SET @V_TOTAL_PEDIDOS_EM_ABERTO = 0;
BEGIN
IF CHARINDEX('G', @V_PARAM_CRIT_CRED) > 0 OR @V_PARAM_CRIT_CRED IS NULL
SELECT @V_TOTAL_PEDIDOS_EM_ABERTO = SUM((DB_PEDI_PRECO_LIQ * DB_PEDI_ESTVLR *
(DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_ATEND)) +
((DB_PEDI_PRECO_LIQ * DB_PEDI_ESTVLR *
(DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_ATEND) * DB_PEDI_IPI / 100)) +
((DB_PEDI_ESTVLR * (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_ATEND) * ISNULL(DB_PEDI_VLRIPI, 0))))
FROM DB_PEDIDO, DB_PEDIDO_PROD, DB_CLIENTE
WHERE DB_PEDIDO.DB_PED_NRO =		 DB_PEDIDO_PROD.DB_PEDI_PEDIDO
AND DB_PEDIDO.DB_PED_CLIENTE =	 DB_CLIENTE.DB_CLI_CODIGO
AND DB_PEDIDO.DB_PED_FATUR =		 0
AND DB_PEDIDO.DB_PED_SITUACAO <	 3
AND DB_PEDIDO_PROD.DB_PEDI_SITUACAO < 2
AND CASE
WHEN @V_PARAM_AN_CRED = 0 AND DB_CLI_CODIGO = @V_PED_CLIENTE
THEN  1
WHEN @V_PARAM_AN_CRED = 1 AND SUBSTRING(DB_CLI_CGCMF, 1, 8) = SUBSTRING(@V_CLI_CGCMF, 1, 8)
THEN 1
WHEN @V_PARAM_AN_CRED = 2 AND DB_CLI_VINCULO = @V_CLI_VINCULO
THEN 1
ELSE 0
END = 1
ELSE
SET @V_TOTAL_PEDIDOS_EM_ABERTO = 0;
END
SET @V_TOTAL_COBRANCA_CLIENTE = 0;
BEGIN
SELECT @V_TOTAL_COBRANCA_CLIENTE = SUM((CR01_SALDO * CR01_DC) + CR01_VLJURO)
FROM MCR01, DB_CLIENTE
WHERE CR01_CLIENTE = DB_CLI_CODIGO
AND CR01_SALDO > 0
AND CASE WHEN @V_PARAM_AN_CRED = 0 AND DB_CLI_CODIGO = @V_PED_CLIENTE
THEN 1
WHEN @V_PARAM_AN_CRED = 1 AND SUBSTRING(DB_CLI_CGCMF, 1,8) = SUBSTRING(@V_CLI_CGCMF,1,8)
THEN 1
WHEN @V_PARAM_AN_CRED = 2 AND DB_CLI_VINCULO = @V_CLI_VINCULO
THEN 1
ELSE 0
END = 1;
END
SET @V_PASSO = 8;
SET @V_TOTAL_LIMITE_DISP = 0;
SELECT @V_AVALIACAOLIMCREDITO = DB_PRMS_VALOR
FROM DB_PARAM_SISTEMA
WHERE DB_PARAM_SISTEMA.DB_PRMS_ID = 'CRE_AVALIACAOLIMCREDITO';
IF @V_AVALIACAOLIMCREDITO = 1
BEGIN
SET @V_TOTAL_LIMITE_DISP = @V_CLILIM
END
ELSE
BEGIN
SELECT @V_TOTAL_LIMITE_DISP = SUM(DB_CLI_LIM_CREDAP)
FROM DB_CLIENTE
WHERE DB_CLI_DATA_LIMITE > GETDATE()
AND CASE WHEN @V_PARAM_AN_CRED = 0 AND DB_CLI_CODIGO = @V_PED_CLIENTE
THEN 1
WHEN @V_PARAM_AN_CRED = 1 AND SUBSTRING(DB_CLI_CGCMF, 1, 8) = SUBSTRING(@V_CLI_CGCMF, 1, 8)
THEN 1
WHEN @V_PARAM_AN_CRED = 2 AND DB_CLI_VINCULO = @V_CLI_VINCULO
THEN 1
ELSE 0
END = 1
GROUP BY DB_CLI_DATA_LIMITE
END
SET @V_PASSO = 9;
BEGIN
IF CHARINDEX('A', @V_MOTIVOS) > 0
SELECT @V_CLIATRS =   SUM((CR01_SALDO * CR01_DC) + CR01_VLJURO)
FROM MCR01, DB_CLIENTE
WHERE CR01_CLIENTE = DB_CLI_CODIGO
AND CR01_DTVCTO <  DATEADD(DAY, @V_DIAS, @V_DATA)
AND CR01_SALDO >   0
AND DBO.MERCF_VALIDA_LISTA (CR01_TIPODOC, @V_PARAM_TPDOC_AVAL, 0, '') > 0
AND CASE WHEN @V_PARAM_AN_CRED = 0 AND DB_CLI_CODIGO = @V_PED_CLIENTE
THEN 1
WHEN @V_PARAM_AN_CRED = 1 AND SUBSTRING(DB_CLI_CGCMF, 1, 8) = SUBSTRING(@V_CLI_CGCMF, 1, 8)
THEN 1
WHEN @V_PARAM_AN_CRED = 2 AND DB_CLI_VINCULO = @V_CLI_VINCULO
THEN 1
ELSE 0
END = 1
SET @V_CLICRED = ISNULL(@V_TOTAL_PEDIDOS_EM_ABERTO, 0) + ISNULL(@V_TOTAL_COBRANCA_CLIENTE, 0);
SET @V_TOTAL_LIMITE_EXC = ISNULL(@V_CLICRED, 0) - ISNULL(@V_TOTAL_LIMITE_DISP, 0);
END
SET @V_PASSO = 10;
SET @V_AUX = 0;
WHILE @V_AUX < LEN(@V_MOTIVOS)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTIVOS,@V_AUX, 1), @V_PERMI) > 0
BEGIN
IF CHARINDEX(SUBSTRING(@V_MOTIVOS,@V_AUX, 1), @V_CFE_VLR) > 0
BEGIN
SET @V_FLG = 0;
SET @V_PASSO = 11;
IF SUBSTRING(@V_MOTIVOS, @V_AUX, 1) = 'A'
BEGIN
IF @V_CLIATRS > @V_VLR_MAXATRS AND @V_VLR_MAXATRS > 0
SET @V_FLG = 1;
IF NOT (@V_TOTAL_LIMITE_DISP = 0 AND @V_VLR_MAXLIM >= 100)
BEGIN
IF @V_CLICRED > (@V_TOTAL_LIMITE_DISP + (@V_TOTAL_LIMITE_DISP * @V_VLR_MAXLIM / 100)) AND @V_VLR_MAXLIM > 0
SET @V_FLG = 1;
END
IF ISNULL(@V_LIB_VLREXCLIM, 0) < ISNULL(@V_TOTAL_LIMITE_EXC, 0) AND ISNULL(@V_LIB_VLREXCLIM, 0) > 0
SET @V_FLG = 1;
IF  (@V_CLICRED > ISNULL(@V_LIB_DIVTOTMAX, 0) AND ISNULL(@V_LIB_DIVTOTMAX, 0) > 0 AND ISNULL(@V_LIB_DIVLIMMAX, 0) = 0)
OR (@V_CLICRED > (ISNULL(@V_LIB_DIVLIMMAX, 0) + ISNULL(@V_TOTAL_LIMITE_DISP, 0)) AND ISNULL(@V_LIB_DIVLIMMAX, 0) > 0 AND ISNULL(@V_LIB_DIVTOTMAX, 0) = 0)
SET @V_FLG = 1;
IF ISNULL(@V_LIB_DIVTOTMAX, 0) > 0 AND ISNULL(@V_LIB_DIVLIMMAX, 0) > 0
IF @V_CLICRED > ISNULL(@V_LIB_DIVTOTMAX, 0) AND @V_CLICRED > (ISNULL(@V_LIB_DIVLIMMAX, 0) + ISNULL(@V_TOTAL_LIMITE_DISP, 0))
SET @V_FLG = 1;
END
SET @V_PASSO = 12;
SET @V_CPGTO_PRZTOT = 0;
IF SUBSTRING(@V_MOTIVOS, @V_AUX, 1) = 'C'
BEGIN
SELECT @V_CPGTO_PRZMED = DB_TBPGTO_PRZMED,
@V_CPGTO_PRZTOT = (CASE  WHEN DB_TBPGTO_DIAS12 > DB_TBPGTO_DIAS11 THEN DB_TBPGTO_DIAS12
WHEN DB_TBPGTO_DIAS11 > DB_TBPGTO_DIAS10 THEN DB_TBPGTO_DIAS11
WHEN DB_TBPGTO_DIAS10 > DB_TBPGTO_DIAS9  THEN DB_TBPGTO_DIAS10
WHEN DB_TBPGTO_DIAS9  > DB_TBPGTO_DIAS8  THEN DB_TBPGTO_DIAS9
WHEN DB_TBPGTO_DIAS8  > DB_TBPGTO_DIAS7  THEN DB_TBPGTO_DIAS8
WHEN DB_TBPGTO_DIAS7  > DB_TBPGTO_DIAS6  THEN DB_TBPGTO_DIAS7
WHEN DB_TBPGTO_DIAS6  > DB_TBPGTO_DIAS5  THEN DB_TBPGTO_DIAS6
WHEN DB_TBPGTO_DIAS5  > DB_TBPGTO_DIAS4  THEN DB_TBPGTO_DIAS5
WHEN DB_TBPGTO_DIAS4  > DB_TBPGTO_DIAS3  THEN DB_TBPGTO_DIAS4
WHEN DB_TBPGTO_DIAS3  > DB_TBPGTO_DIAS2  THEN DB_TBPGTO_DIAS3
WHEN DB_TBPGTO_DIAS2  > DB_TBPGTO_DIAS1  THEN DB_TBPGTO_DIAS2
ELSE DB_TBPGTO_DIAS1 END)
FROM DB_TB_CPGTO
WHERE DB_TBPGTO_COD = @V_PED_COND_PGTO;
IF ISNULL(@V_LIB_PRZMED_MAX, 0) > 0
IF ISNULL(@V_CPGTO_PRZMED, 0) > ISNULL(@V_LIB_PRZMED_MAX, 0)
SET @V_FLG = 1;
IF ISNULL(@V_LIB_PRZTOT_MAX, 0) > 0 AND @V_FLG = 0
IF ISNULL(@V_CPGTO_PRZTOT, 0) > ISNULL(@V_LIB_PRZTOT_MAX, 0)
SET @V_FLG = 1;
IF @V_FLG = 0
BEGIN
SELECT @V_DB_CLIR_PRAZO_MAX = DB_CLIR_PRAZO_MAX
FROM DB_CLIENTE_REPRES
WHERE DB_CLIR_CLIENTE = @V_PED_CLIENTE
AND DB_CLIR_REPRES = @V_PED_REPRES
AND DB_CLIR_EMPRESA = @V_PED_EMPRESA;
IF ISNULL(@V_LIB_PRZMEDEXCCLI, 0) > 0
IF (ISNULL(@V_CPGTO_PRZMED, 0) - ISNULL(@V_DB_CLIR_PRAZO_MAX, 0)) > ISNULL(@V_LIB_PRZMEDEXCCLI, 0)
SET @V_FLG = 1;
END
END
SET @V_PASSO = 13;
IF SUBSTRING(@V_MOTIVOS, @V_AUX, 1) = 'D'
BEGIN
SET @VPED_NRODESCTOITEM = 0
SELECT @VPED_NRODESCTOITEM = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'PED_NRODESCTOITEM';
IF @V_ALCP_AVALIADESCONTO = 1
BEGIN
IF @V_ALCP_TIPOAVALIADESCONTO = 0
BEGIN
SET @VPED_REGRAPERCENTUALECO = 0;
SELECT @VPED_REGRAPERCENTUALECO = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'PED_REGRAPERCENTUALECO';
SELECT @VDB_PED_DESCTO	  = CASE WHEN CHARINDEX('1', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO END,
@VDB_PED_DESCTO2  = CASE WHEN CHARINDEX('2', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO2 END,
@VDB_PED_DESCTO3  = CASE WHEN CHARINDEX('3', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO3 END,
@VDB_PED_DESCTO4  = CASE WHEN CHARINDEX('4', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO4 END,
@VDB_PED_DESCTO5  = CASE WHEN CHARINDEX('5', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO5 END,
@VDB_PED_DESCTO6  = CASE WHEN CHARINDEX('6', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO6 END,
@VDB_PED_DESCTO7  = CASE WHEN CHARINDEX('7', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO7 END,
@V_ACRESCIMO_PEDIDO = ISNULL(DB_PED_ACRESCIMO, 0)
FROM DB_PEDIDO
WHERE DB_PED_NRO = @P_NRO
DECLARE CUR_PED_DESCTOS CURSOR
FOR SELECT DB_PEDD_DCTOPOL, DB_PEDD_INDDESCTO, DB_PEDD_TPDESC
FROM DB_PEDIDO_DESCONTO
WHERE DB_PEDD_NRO = @P_NRO
AND DB_PEDD_SEQIT = 0
OPEN CUR_PED_DESCTOS
FETCH NEXT FROM CUR_PED_DESCTOS
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
WHILE @@FETCH_STATUS = 0
BEGIN
IF @V_DB_PEDD_TPDESC = 0
BEGIN
IF @VDB_PEDD_INDDESCTO = 1 AND CHARINDEX('1', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 2 AND CHARINDEX('2', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO2 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 3 AND CHARINDEX('3', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO3 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 4 AND CHARINDEX('4', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO4 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 5 AND CHARINDEX('5', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO5 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 6 AND CHARINDEX('6', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO6 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 7 AND CHARINDEX('7', ISNULL(@VDB_ALCP_INDTOTDCTO, ' ')) = 0
SET @V_PED_DSCTO7 = @VDB_PEDD_DESCONTO
END
ELSE IF @V_DB_PEDD_TPDESC = 1
BEGIN
SET @V_ACRESCIMO_PEDIDO_POL = @VDB_PEDD_DESCONTO
END
FETCH NEXT FROM CUR_PED_DESCTOS
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
END
CLOSE CUR_PED_DESCTOS
DEALLOCATE CUR_PED_DESCTOS
DECLARE CUR_PED_PROD CURSOR
FOR SELECT DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_LIQ,
DB_PEDI_QTDE_SOLIC * DB_PEDI_ECON_VLR,
DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_UNIT,
DB_PROD_MARCA, DB_PROD_TPPROD, DB_PROD_FAMILIA, DB_PROD_CODIGO, DB_PROD_GRUPO,
DB_PEDI_PRECO_UNIT,
DB_PEDI_SEQUENCIA,
DB_PEDI_QTDE_SOLIC,
DB_PEDI_DESCTOP,
DB_PEDI_ACRESCIMO
FROM DB_PEDIDO_PROD,   DB_PRODUTO
WHERE DB_PEDI_PEDIDO =  @P_NRO
AND DB_PEDI_PRODUTO = DB_PROD_CODIGO
AND DB_PEDI_TIPO NOT IN ('B', 'T');
OPEN CUR_PED_PROD
FETCH NEXT FROM CUR_PED_PROD
INTO  @VPEDIDO_TOTAL_ITEM, @VECONOMIA_ITEM, @V_VALOR_BRUTO_ITEM, @V_MARCA, @V_TIPO, @V_FAMILIA, @V_CODIGO_PRODUTO, @V_GRUPO, @V_PRECO_BRUTO_UNIT, @V_SEQ_ITEM, @V_QUANTIDADE_ITEM_ECON, @VDB_PEDI_DESCTOP, @V_DB_PEDI_ACRESCIMO
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_ITEM_DSCTO_0 = 0;
SET @V_ITEM_DSCTO_1 = 0;
SET @V_ITEM_DSCTO_2 = 0;
SET @V_ITEM_DSCTO_3 = 0;
SET @V_ITEM_DSCTO_4 = 0;
SET @V_ITEM_DSCTO_5 = 0;
SET @V_ITEM_DSCTO_6 = 0;
SET @V_ITEM_DSCTO_7 = 0;
SET @V_ITEM_DSCTO_8 = 0;
SET @V_ITEM_DSCTO_9 = 0;
SET @V_ITEM_DSCTO_10 = 0;
SET @V_ACRESCIMO_ITEM = 0;
IF @VPED_NRODESCTOITEM = 1
BEGIN
SET @V_ITEM_DSCTO_0 = @VDB_PEDI_DESCTOP
SET @V_ACRESCIMO_ITEM = @V_DB_PEDI_ACRESCIMO
END
ELSE
BEGIN
DECLARE CUR_PED_ITEM_DESCTO1 CURSOR
FOR SELECT DB_PEDD_DESCONTO, DB_PEDD_INDDESCTO, DB_PEDD_TPDESC
FROM DB_PEDIDO_DESCONTO
WHERE DB_PEDD_NRO = @P_NRO
AND DB_PEDD_SEQIT = @V_SEQ_ITEM
OPEN CUR_PED_ITEM_DESCTO1
FETCH NEXT FROM CUR_PED_ITEM_DESCTO1
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_ITEM_DSCTO_0 = 0;
IF @V_DB_PEDD_TPDESC = 0
BEGIN
IF @VDB_PEDD_INDDESCTO = 1 AND CHARINDEX('1', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_1 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 2 AND CHARINDEX('2', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_2 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 3 AND CHARINDEX('3', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_3 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 4 AND CHARINDEX('4', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_4 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 5 AND CHARINDEX('5', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_5 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 6 AND CHARINDEX('6', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_6 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 7 AND CHARINDEX('7', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_7 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 8 AND CHARINDEX('8', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_8 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 9 AND CHARINDEX('9', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_9 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 10 AND CHARINDEX('10', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_10 = @VDB_PEDD_DESCONTO
END
ELSE IF @V_DB_PEDD_TPDESC = 1
BEGIN
SET @V_ACRESCIMO_ITEM = @VDB_PEDD_DESCONTO
END
FETCH NEXT FROM CUR_PED_ITEM_DESCTO1
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
END
CLOSE CUR_PED_ITEM_DESCTO1
DEALLOCATE CUR_PED_ITEM_DESCTO1
END
SELECT @V_DESCTO_TOTAL = DBO.MERCF_RET_DESCTO_CASCATA_2(  @VDB_PED_DESCTO,
@VDB_PED_DESCTO2,
@VDB_PED_DESCTO3,
@VDB_PED_DESCTO4,
@VDB_PED_DESCTO5,
@VDB_PED_DESCTO6,
@VDB_PED_DESCTO7,
@V_ITEM_DSCTO_0,
@V_ITEM_DSCTO_1,
@V_ITEM_DSCTO_2,
@V_ITEM_DSCTO_3,
@V_ITEM_DSCTO_4,
@V_ITEM_DSCTO_5,
@V_ITEM_DSCTO_6,
@V_ITEM_DSCTO_7,
@V_ITEM_DSCTO_8,
@V_ITEM_DSCTO_9,
@V_ITEM_DSCTO_10,
@V_ACRESCIMO_PEDIDO,
0 )
SET @V_PRECO_APLICADO = @V_PRECO_BRUTO_UNIT - ((@V_PRECO_BRUTO_UNIT * @V_DESCTO_TOTAL ) / 100)
SET @V_PRECO_APLICADO = @V_PRECO_APLICADO + ((@V_PRECO_APLICADO * @V_ACRESCIMO_ITEM ) / 100)
SET @VPEDIDO_TOTAL_ITEM = 0;
SET @VPEDIDO_TOTAL_ITEM = @V_PRECO_APLICADO * @V_QUANTIDADE_ITEM_ECON;
SET @V_ITEM_DSCTO_0 = 0;
SET @V_ITEM_DSCTO_1 = 0;
SET @V_ITEM_DSCTO_2 = 0;
SET @V_ITEM_DSCTO_3 = 0;
SET @V_ITEM_DSCTO_4 = 0;
SET @V_ITEM_DSCTO_5 = 0;
SET @V_ITEM_DSCTO_6 = 0;
SET @V_ITEM_DSCTO_7 = 0;
SET @V_ITEM_DSCTO_8 = 0;
SET @V_ITEM_DSCTO_9 = 0;
SET @V_ITEM_DSCTO_10 = 0;
SET @V_DESCTO_ITEM_REGRA = NULL;
SET @V_ACRESCIMO_ITEM = 0;
IF @VPED_NRODESCTOITEM = 1
BEGIN
DECLARE CUR_PED_ITEM_DESCTO2 CURSOR
FOR SELECT DB_PEDD_DCTOPOL, DB_PEDD_INDDESCTO, DB_PEDD_TPDESC
FROM DB_PEDIDO_DESCONTO
WHERE DB_PEDD_NRO = @P_NRO
AND DB_PEDD_SEQIT = @V_SEQ_ITEM
AND DB_PEDD_INDDESCTO IN (1, 2, 3)
OPEN CUR_PED_ITEM_DESCTO2
FETCH NEXT FROM CUR_PED_ITEM_DESCTO2
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
WHILE @@FETCH_STATUS = 0
BEGIN
IF @V_DB_PEDD_TPDESC = 0
BEGIN
IF @VDB_PEDD_INDDESCTO = 1 AND CHARINDEX('1', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_1 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 2 AND CHARINDEX('2', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_2 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 3 AND CHARINDEX('3', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_3 = @VDB_PEDD_DESCONTO
END
ELSE IF @V_DB_PEDD_TPDESC = 1
BEGIN
SET @V_ACRESCIMO_ITEM = @VDB_PEDD_DESCONTO
END
FETCH NEXT FROM CUR_PED_ITEM_DESCTO2
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
END
CLOSE CUR_PED_ITEM_DESCTO2
DEALLOCATE CUR_PED_ITEM_DESCTO2
END
ELSE
BEGIN
DECLARE CUR_PED_ITEM_DESCTO2 CURSOR
FOR SELECT DB_PEDD_DCTOPOL, DB_PEDD_INDDESCTO, DB_PEDD_TPDESC
FROM DB_PEDIDO_DESCONTO
WHERE DB_PEDD_NRO = @P_NRO
AND DB_PEDD_SEQIT = @V_SEQ_ITEM
OPEN CUR_PED_ITEM_DESCTO2
FETCH NEXT FROM CUR_PED_ITEM_DESCTO2
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_ITEM_DSCTO_0 = 0;
IF @V_DB_PEDD_TPDESC = 0
BEGIN
IF @VDB_PEDD_INDDESCTO = 1 AND CHARINDEX('1', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_1 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 2 AND CHARINDEX('2', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_2 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 3 AND CHARINDEX('3', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_3 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 4 AND CHARINDEX('4', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_4 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 5 AND CHARINDEX('5', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_5 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 6 AND CHARINDEX('6', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_6 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 7 AND CHARINDEX('7', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_7 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 8 AND CHARINDEX('8', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_8 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 9 AND CHARINDEX('9', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_9 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 10 AND CHARINDEX('10', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_10 = @VDB_PEDD_DESCONTO
END
ELSE IF @V_DB_PEDD_TPDESC = 1
BEGIN
SET @V_ACRESCIMO_ITEM = @VDB_PEDD_DESCONTO
END
FETCH NEXT FROM CUR_PED_ITEM_DESCTO2
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
END
CLOSE CUR_PED_ITEM_DESCTO2
DEALLOCATE CUR_PED_ITEM_DESCTO2
END
SELECT @V_DESCTO_TOTAL = DBO.MERCF_RET_DESCTO_CASCATA_2(  @V_PED_DSCTO,
@V_PED_DSCTO2,
@V_PED_DSCTO3,
@V_PED_DSCTO4,
@V_PED_DSCTO5,
@V_PED_DSCTO6,
@V_PED_DSCTO7,
@V_ITEM_DSCTO_0,
@V_ITEM_DSCTO_1,
@V_ITEM_DSCTO_2,
@V_ITEM_DSCTO_3,
@V_ITEM_DSCTO_4,
@V_ITEM_DSCTO_5,
@V_ITEM_DSCTO_6,
@V_ITEM_DSCTO_7,
@V_ITEM_DSCTO_8,
@V_ITEM_DSCTO_9,
@V_ITEM_DSCTO_10,
@V_ACRESCIMO_PEDIDO_POL,
0)
SET @V_PRECO_POLITICA = @V_PRECO_BRUTO_UNIT - ((@V_PRECO_BRUTO_UNIT * @V_DESCTO_TOTAL ) / 100)
SET @V_PRECO_POLITICA = @V_PRECO_POLITICA + ((@V_PRECO_POLITICA * @V_ACRESCIMO_ITEM ) / 100)
SET @VECONOMIA_ITEM = (@V_PRECO_APLICADO - @V_PRECO_POLITICA) * @V_QUANTIDADE_ITEM_ECON
SET @V_DESCTO_ITEM_REGRA = NULL;
IF @V_ALCP_REGRAEXCDESCONTO <> 0
BEGIN
SET @V_DESCTO_ITEM_REGRA = NULL;
SELECT TOP 1 @V_DESCTO_ITEM_REGRA = PROD.DESCONTO
FROM DB_REGRASDESCLIBERACAO CAPA
, DB_REGRASDESCLIB_PRODUTOS PROD
WHERE CAPA.CODIGO = PROD.CODIGO
AND CAPA.CODIGO = @V_ALCP_REGRAEXCDESCONTO
AND GETDATE() BETWEEN CAPA.DATA_INICIAL  AND CAPA.DATA_FINAL
AND DBO.MERCF_VALIDA_LISTA(@V_CODIGO_PRODUTO, PRODUTO, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_TIPO, TIPO, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_MARCA, MARCA, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_FAMILIA, FAMILIA, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_GRUPO, GRUPO, 0, ',') = 1
ORDER BY PESO DESC;
END
IF ISNULL(@V_DESCTO_ITEM_REGRA, '') = ''
SET @V_LIB_DCTMAX_ITEM = @V_LIB_DCTMAX;
ELSE
SET @V_LIB_DCTMAX_ITEM = @V_DESCTO_ITEM_REGRA;
IF @VPED_REGRAPERCENTUALECO IN (0, 3)
BEGIN
SET @V_DESCONTO_PED_ITEM = ((@VECONOMIA_ITEM * 100) / (@VPEDIDO_TOTAL_ITEM - @VECONOMIA_ITEM)) * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @V_LIB_DCTMAX_ITEM
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
ELSE
BEGIN
SET @V_DESCONTO_PED_ITEM = ((@VECONOMIA_ITEM * 100) / (@V_VALOR_BRUTO_ITEM)) * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @V_LIB_DCTMAX_ITEM
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
FETCH NEXT FROM CUR_PED_PROD
INTO @VPEDIDO_TOTAL_ITEM, @VECONOMIA_ITEM, @V_VALOR_BRUTO_ITEM, @V_MARCA, @V_TIPO, @V_FAMILIA, @V_CODIGO_PRODUTO, @V_GRUPO, @V_PRECO_BRUTO_UNIT, @V_SEQ_ITEM, @V_QUANTIDADE_ITEM_ECON, @VDB_PEDI_DESCTOP, @V_DB_PEDI_ACRESCIMO
END
CLOSE CUR_PED_PROD
DEALLOCATE CUR_PED_PROD
END
ELSE IF @V_ALCP_TIPOAVALIADESCONTO = 1
BEGIN
SET @VDB_PED_DESCTO = 0
SET @VDB_PED_DESCTO2 = 0
SET @VDB_PED_DESCTO3 = 0
SET @VDB_PED_DESCTO4 = 0
SET @VDB_PED_DESCTO5 = 0
SET @VDB_PED_DESCTO6 = 0
SET @VDB_PED_DESCTO7 = 0
SET @V_ACRESCIMO_PEDIDO = 0
SELECT @VDB_PED_DESCTO	  = CASE WHEN CHARINDEX('1', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO END,
@VDB_PED_DESCTO2  = CASE WHEN CHARINDEX('2', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO2 END,
@VDB_PED_DESCTO3  = CASE WHEN CHARINDEX('3', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO3 END,
@VDB_PED_DESCTO4  = CASE WHEN CHARINDEX('4', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO4 END,
@VDB_PED_DESCTO5  = CASE WHEN CHARINDEX('5', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO5 END,
@VDB_PED_DESCTO6  = CASE WHEN CHARINDEX('6', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO6 END,
@VDB_PED_DESCTO7  = CASE WHEN CHARINDEX('7', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO7 END,
@V_ACRESCIMO_PEDIDO = ISNULL(DB_PED_ACRESCIMO, 0)
FROM DB_PEDIDO
WHERE DB_PED_NRO = @P_NRO
DECLARE CUR_PED_PROD CURSOR
FOR SELECT DB_PEDI_DESCTOP, DB_PEDI_SEQUENCIA, DB_PROD_MARCA, DB_PROD_TPPROD, DB_PROD_FAMILIA, DB_PROD_CODIGO, DB_PROD_GRUPO, DB_PEDI_ACRESCIMO
FROM DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PEDIDO = @P_NRO
AND DB_PEDI_PRODUTO = DB_PROD_CODIGO
OPEN CUR_PED_PROD
FETCH NEXT FROM CUR_PED_PROD
INTO @VDB_PEDI_DESCTOP, @V_SEQ_ITEM, @V_MARCA, @V_TIPO, @V_FAMILIA, @V_CODIGO_PRODUTO, @V_GRUPO, @V_DB_PEDI_ACRESCIMO
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_ITEM_DSCTO_0 = 0;
SET @V_ITEM_DSCTO_1 = 0;
SET @V_ITEM_DSCTO_2 = 0;
SET @V_ITEM_DSCTO_3 = 0;
SET @V_ITEM_DSCTO_4 = 0;
SET @V_ITEM_DSCTO_5 = 0;
SET @V_ITEM_DSCTO_6 = 0;
SET @V_ITEM_DSCTO_7 = 0;
SET @V_ITEM_DSCTO_8 = 0;
SET @V_ITEM_DSCTO_9 = 0;
SET @V_ITEM_DSCTO_10 = 0;
SET @V_DESCTO_ITEM_REGRA = NULL;
SET @V_ACRESCIMO_ITEM = 0
IF @VPED_NRODESCTOITEM = 1
BEGIN
SET @V_ITEM_DSCTO_0 = @VDB_PEDI_DESCTOP
SET @V_ACRESCIMO_ITEM = @V_DB_PEDI_ACRESCIMO;
END
ELSE
BEGIN
DECLARE CUR_PED_ITEM_DESCTO CURSOR
FOR SELECT DB_PEDD_DESCONTO, DB_PEDD_INDDESCTO, DB_PEDD_TPDESC
FROM DB_PEDIDO_DESCONTO
WHERE DB_PEDD_NRO = @P_NRO
AND DB_PEDD_SEQIT = @V_SEQ_ITEM
OPEN CUR_PED_ITEM_DESCTO
FETCH NEXT FROM CUR_PED_ITEM_DESCTO
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_ITEM_DSCTO_0 = 0;
IF @V_DB_PEDD_TPDESC = 0
BEGIN
IF @VDB_PEDD_INDDESCTO = 1 AND CHARINDEX('1', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_1 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 2 AND CHARINDEX('2', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_2 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 3 AND CHARINDEX('3', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_3 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 4 AND CHARINDEX('4', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_4 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 5 AND CHARINDEX('5', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_5 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 6 AND CHARINDEX('6', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_6 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 7 AND CHARINDEX('7', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_7 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 8 AND CHARINDEX('8', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_8 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 9 AND CHARINDEX('9', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_9 = @VDB_PEDD_DESCONTO
IF @VDB_PEDD_INDDESCTO = 10 AND CHARINDEX('10', ISNULL(@V_ALCP_INDICEDESCITEM, ' ')) = 0
SET @V_ITEM_DSCTO_10 = @VDB_PEDD_DESCONTO
END IF @V_DB_PEDD_TPDESC = 1
BEGIN
SET @V_ACRESCIMO_ITEM = @VDB_PEDD_DESCONTO
END
FETCH NEXT FROM CUR_PED_ITEM_DESCTO
INTO @VDB_PEDD_DESCONTO, @VDB_PEDD_INDDESCTO, @V_DB_PEDD_TPDESC
END
CLOSE CUR_PED_ITEM_DESCTO
DEALLOCATE CUR_PED_ITEM_DESCTO
END
SELECT @V_DESCTO_TOTAL = DBO.MERCF_RET_DESCTO_CASCATA_2(  @VDB_PED_DESCTO,
@VDB_PED_DESCTO2,
@VDB_PED_DESCTO3,
@VDB_PED_DESCTO4,
@VDB_PED_DESCTO5,
@VDB_PED_DESCTO6,
@VDB_PED_DESCTO7,
@V_ITEM_DSCTO_0,
@V_ITEM_DSCTO_1,
@V_ITEM_DSCTO_2,
@V_ITEM_DSCTO_3,
@V_ITEM_DSCTO_4,
@V_ITEM_DSCTO_5,
@V_ITEM_DSCTO_6,
@V_ITEM_DSCTO_7,
@V_ITEM_DSCTO_8,
@V_ITEM_DSCTO_9,
@V_ITEM_DSCTO_10,
@V_ACRESCIMO_PEDIDO,
@V_ACRESCIMO_ITEM)
IF @V_ALCP_REGRAEXCDESCONTO <> 0
BEGIN
SET @V_DESCTO_ITEM_REGRA = NULL;
SELECT TOP 1 @V_DESCTO_ITEM_REGRA = PROD.DESCONTO
FROM DB_REGRASDESCLIBERACAO CAPA
, DB_REGRASDESCLIB_PRODUTOS PROD
WHERE CAPA.CODIGO = PROD.CODIGO
AND CAPA.CODIGO = @V_ALCP_REGRAEXCDESCONTO
AND GETDATE() BETWEEN CAPA.DATA_INICIAL  AND CAPA.DATA_FINAL
AND DBO.MERCF_VALIDA_LISTA(@V_CODIGO_PRODUTO, PRODUTO, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_TIPO, TIPO, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_MARCA, MARCA, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_FAMILIA, FAMILIA, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_GRUPO, GRUPO, 0, ',') = 1
ORDER BY PESO DESC;
END
SET @V_DESCONTO_PED_ITEM = @V_DESCTO_TOTAL
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCTO_ITEM_REGRA IS NOT NULL
BEGIN
IF (@V_DESCTO_TOTAL > @V_DESCTO_ITEM_REGRA)
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
ELSE
BEGIN
IF (@V_DESCTO_TOTAL > @VDB_ALCP_TOTDCTO)
BEGIN
SET @V_FLG = 1;
BREAK;
END;
END
FETCH NEXT FROM CUR_PED_PROD
INTO  @VDB_PEDI_DESCTOP, @V_SEQ_ITEM, @V_MARCA, @V_TIPO, @V_FAMILIA, @V_CODIGO_PRODUTO, @V_GRUPO, @V_DB_PEDI_ACRESCIMO
END
CLOSE CUR_PED_PROD
DEALLOCATE CUR_PED_PROD
END
ELSE IF @V_ALCP_TIPOAVALIADESCONTO = 2
BEGIN
DECLARE CUR_PED_PROD CURSOR
FOR SELECT DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_LIQ,
DB_PEDI_QTDE_SOLIC * DB_PEDI_ECON_VLR,
DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_UNIT,
DB_PROD_MARCA, DB_PROD_TPPROD, DB_PROD_FAMILIA, DB_PROD_CODIGO, DB_PROD_GRUPO
FROM DB_PEDIDO_PROD,   DB_PRODUTO
WHERE DB_PEDI_PEDIDO =  @P_NRO
AND DB_PEDI_PRODUTO = DB_PROD_CODIGO
AND DB_PEDI_TIPO NOT IN ('B', 'T');
OPEN CUR_PED_PROD
FETCH NEXT FROM CUR_PED_PROD
INTO  @VPEDIDO_TOTAL_ITEM, @VECONOMIA_ITEM, @V_VALOR_BRUTO_ITEM, @V_MARCA, @V_TIPO, @V_FAMILIA, @V_CODIGO_PRODUTO, @V_GRUPO
WHILE @@FETCH_STATUS = 0
BEGIN
SET @V_DESCTO_ITEM_REGRA = NULL;
IF @V_ALCP_REGRAEXCDESCONTO <> 0
BEGIN
SET @V_DESCTO_ITEM_REGRA = NULL;
SELECT @V_DESCTO_ITEM_REGRA = PROD.DESCONTO
FROM DB_REGRASDESCLIBERACAO CAPA
, DB_REGRASDESCLIB_PRODUTOS PROD
WHERE CAPA.CODIGO = PROD.CODIGO
AND CAPA.CODIGO = @V_ALCP_REGRAEXCDESCONTO
AND GETDATE() BETWEEN CAPA.DATA_INICIAL  AND CAPA.DATA_FINAL
AND DBO.MERCF_VALIDA_LISTA(@V_CODIGO_PRODUTO, PRODUTO, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_TIPO, TIPO, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_MARCA, MARCA, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_FAMILIA, FAMILIA, 0, ',') = 1
AND DBO.MERCF_VALIDA_LISTA(@V_GRUPO, GRUPO, 0, ',') = 1
ORDER BY PESO DESC;
END
IF @V_PRM_APLDESCTO = 0
BEGIN
IF  @VPEDIDO_TOTAL_ITEM > 0
SET @V_PED_DCTO_ITEM = @VECONOMIA_ITEM * 100 / @VPEDIDO_TOTAL_ITEM;
END
ELSE
BEGIN
IF @V_VALOR_BRUTO_ITEM > 0
SET @V_PED_DCTO_ITEM = @VECONOMIA_ITEM * 100 / @V_VALOR_BRUTO_ITEM;
END
SET @V_DESCONTO_PED_ITEM = @V_PED_DCTO_ITEM * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF ISNULL(@V_DESCTO_ITEM_REGRA, '') <> ''
BEGIN
IF @V_PED_DCTO_ITEM > @V_DESCTO_ITEM_REGRA
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
ELSE
BEGIN
IF @V_PED_DCTO_ITEM > @VDB_ALCP_ECONOMIA
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
FETCH NEXT FROM CUR_PED_PROD
INTO @VPEDIDO_TOTAL_ITEM, @VECONOMIA_ITEM, @V_VALOR_BRUTO_ITEM, @V_MARCA, @V_TIPO, @V_FAMILIA, @V_CODIGO_PRODUTO, @V_GRUPO
END
CLOSE CUR_PED_PROD
DEALLOCATE CUR_PED_PROD
END
END
ELSE
BEGIN
IF ISNULL(@VDB_ALCP_TOTDCTO, 0) > 0
BEGIN
SET @VDB_PED_DESCTO = 0
SET @VDB_PED_DESCTO2 = 0
SET @VDB_PED_DESCTO3 = 0
SET @VDB_PED_DESCTO4 = 0
SET @VDB_PED_DESCTO5 = 0
SET @VDB_PED_DESCTO6 = 0
SET @VDB_PED_DESCTO7 = 0
SELECT @VDB_PED_DESCTO	 = CASE WHEN CHARINDEX('1', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO END,
@VDB_PED_DESCTO2	 = CASE WHEN CHARINDEX('2', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO2 END,
@VDB_PED_DESCTO3	 = CASE WHEN CHARINDEX('3', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO3 END,
@VDB_PED_DESCTO4	 = CASE WHEN CHARINDEX('4', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO4 END,
@VDB_PED_DESCTO5	 = CASE WHEN CHARINDEX('5', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO5 END,
@VDB_PED_DESCTO6	 = CASE WHEN CHARINDEX('6', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO6 END,
@VDB_PED_DESCTO7	 = CASE WHEN CHARINDEX('7', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO7 END
FROM DB_PEDIDO
WHERE DB_PED_NRO = @P_NRO
DECLARE CUR_PED_PROD CURSOR
FOR SELECT DB_PEDI_DESCTOP
FROM DB_PEDIDO_PROD
WHERE DB_PEDI_PEDIDO = @P_NRO
OPEN CUR_PED_PROD
FETCH NEXT FROM CUR_PED_PROD
INTO @VDB_PEDI_DESCTOP
WHILE @@FETCH_STATUS = 0
BEGIN
SELECT @V_DESCTO_TOTAL = DBO.MERCF_RET_DESCTO_CASCATA_2( @VDB_PED_DESCTO,
@VDB_PED_DESCTO2,
@VDB_PED_DESCTO3,
@VDB_PED_DESCTO4,
@VDB_PED_DESCTO5,
@VDB_PED_DESCTO6,
@VDB_PED_DESCTO7,
@VDB_PEDI_DESCTOP,
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,0,0)
SET @V_DESCONTO_PED_ITEM = @V_DESCTO_TOTAL
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF  (@V_DESCTO_TOTAL > @VDB_ALCP_TOTDCTO)
BEGIN
SET @V_FLG = 1
BREAK
END
FETCH NEXT FROM CUR_PED_PROD
INTO  @VDB_PEDI_DESCTOP
END
CLOSE CUR_PED_PROD
DEALLOCATE CUR_PED_PROD
END
ELSE
BEGIN
IF @VDB_ALCP_ECONOMIA > 0
BEGIN
SET @V_DESCONTO_PED_ITEM = (@V_PED_DCTO * (-1))
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @VDB_ALCP_ECONOMIA
SET @V_FLG = 1;
END;
IF 	@V_LIB_DCTMAX > 0
BEGIN
SET @V_PARAM_VALDESCONTOEXCEDIDO = 0;
SELECT @V_PARAM_VALDESCONTOEXCEDIDO = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'LIB_VALDESCONTOEXCEDIDO';
SELECT @VPED_REGRAPERCENTUALECO = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'PED_REGRAPERCENTUALECO';
IF @V_PARAM_VALDESCONTOEXCEDIDO = 0
BEGIN
IF @VPED_REGRAPERCENTUALECO = 0
BEGIN
SET @V_DESCONTO_PED_ITEM = ((@V_ECON * 100) / (@V_PED_TOT - @V_ECON)) * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @V_LIB_DCTMAX
SET @V_FLG = 1;
END
ELSE
BEGIN
SET @V_DESCONTO_PED_ITEM = ((@V_ECON * 100) / (@V_BRUTO)) * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @V_LIB_DCTMAX
SET @V_FLG = 1;
END
END
ELSE IF @V_PARAM_VALDESCONTOEXCEDIDO = 1
BEGIN
DECLARE CUR_PED_PROD CURSOR
FOR SELECT DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_LIQ,
DB_PEDI_QTDE_SOLIC * DB_PEDI_ECON_VLR,
DB_PEDI_QTDE_SOLIC * DB_PEDI_PRECO_UNIT
FROM DB_PEDIDO_PROD,   DB_PRODUTO
WHERE DB_PEDI_PEDIDO =  @P_NRO
AND DB_PEDI_PRODUTO = DB_PROD_CODIGO
AND DB_PEDI_TIPO NOT IN ('B', 'T');
OPEN CUR_PED_PROD
FETCH NEXT FROM CUR_PED_PROD
INTO  @VPEDIDO_TOTAL_ITEM, @VECONOMIA_ITEM, @V_VALOR_BRUTO_ITEM
WHILE @@FETCH_STATUS = 0
BEGIN
IF @VPED_REGRAPERCENTUALECO = 0
BEGIN
SET @V_DESCONTO_PED_ITEM = ((@VECONOMIA_ITEM * 100) / (@VPEDIDO_TOTAL_ITEM - @VECONOMIA_ITEM)) * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @V_LIB_DCTMAX
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
ELSE
BEGIN
SET @V_DESCONTO_PED_ITEM = ((@VECONOMIA_ITEM * 100) / (@V_VALOR_BRUTO_ITEM)) * (-1)
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF @V_DESCONTO_PED_ITEM > @V_LIB_DCTMAX
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
FETCH NEXT FROM CUR_PED_PROD
INTO @VPEDIDO_TOTAL_ITEM, @VECONOMIA_ITEM, @V_VALOR_BRUTO_ITEM
END
CLOSE CUR_PED_PROD
DEALLOCATE CUR_PED_PROD
END
END;
IF @VDB_ALCP_DESCTOMEDIO > 0
BEGIN
SET @VDB_PED_DESCTO = 0
SET @VDB_PED_DESCTO2 = 0
SET @VDB_PED_DESCTO3 = 0
SET @VDB_PED_DESCTO4 = 0
SET @VDB_PED_DESCTO5 = 0
SET @VDB_PED_DESCTO6 = 0
SET @VDB_PED_DESCTO7 = 0
SELECT @VDB_PED_DESCTO	 = CASE WHEN CHARINDEX('1', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO END,
@VDB_PED_DESCTO2	 = CASE WHEN CHARINDEX('2', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO2 END,
@VDB_PED_DESCTO3	 = CASE WHEN CHARINDEX('3', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO3 END,
@VDB_PED_DESCTO4	 = CASE WHEN CHARINDEX('4', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO4 END,
@VDB_PED_DESCTO5	 = CASE WHEN CHARINDEX('5', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO5 END,
@VDB_PED_DESCTO6	 = CASE WHEN CHARINDEX('6', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO6 END,
@VDB_PED_DESCTO7	 = CASE WHEN CHARINDEX('7', @VDB_ALCP_INDTOTDCTO) > 0 THEN 0 ELSE DB_PED_DESCTO7 END
FROM DB_PEDIDO
WHERE DB_PED_NRO     = @P_NRO
SET @V_VALOR_LIQ_TOTAL_DESCONTOS = 0;
SET @V_VALOR_BRU_TOTAL           = 0;
DECLARE CUR_PED_PROD2 CURSOR
FOR SELECT DB_PEDI_DESCTOP, DB_PEDI_PRECO_UNIT, DB_PEDI_QTDE_SOLIC, DB_PEDI_QTDE_CANC
FROM DB_PEDIDO_PROD
WHERE DB_PEDI_PEDIDO = @P_NRO
OPEN CUR_PED_PROD2
FETCH NEXT FROM CUR_PED_PROD2
INTO @VDB_PEDI_DESCTOP, @VDB_PEDI_PRECO_UNIT, @VDB_PEDI_QTDE_SOLIC, @VDB_PEDI_QTDE_CANC
WHILE @@FETCH_STATUS = 0
BEGIN
SELECT @V_DESCTO_TOTAL = DBO.MERCF_RET_DESCTO_CASCATA_2( @VDB_PED_DESCTO,
@VDB_PED_DESCTO2,
@VDB_PED_DESCTO3,
@VDB_PED_DESCTO4,
@VDB_PED_DESCTO5,
@VDB_PED_DESCTO6,
@VDB_PED_DESCTO7,
@VDB_PEDI_DESCTOP,
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,0,0)
SET @V_VALOR_TEMP = (@VDB_PEDI_PRECO_UNIT * (@VDB_PEDI_QTDE_SOLIC - @VDB_PEDI_QTDE_CANC)) -
((@VDB_PEDI_PRECO_UNIT * (@VDB_PEDI_QTDE_SOLIC - @VDB_PEDI_QTDE_CANC) * @V_DESCTO_TOTAL) / 100);
SET @V_VALOR_LIQ_TOTAL_DESCONTOS = @V_VALOR_LIQ_TOTAL_DESCONTOS + @V_VALOR_TEMP;
SET @V_VALOR_BRU_TOTAL           = @V_VALOR_BRU_TOTAL + (@VDB_PEDI_PRECO_UNIT * (@VDB_PEDI_QTDE_SOLIC - @VDB_PEDI_QTDE_CANC));
SET @V_DESCONTO_ITEM = 100 - ((@V_VALOR_TEMP / (@VDB_PEDI_PRECO_UNIT * (@VDB_PEDI_QTDE_SOLIC - @VDB_PEDI_QTDE_CANC))) * 100);
FETCH NEXT FROM CUR_PED_PROD2
INTO @VDB_PEDI_DESCTOP, @VDB_PEDI_PRECO_UNIT, @VDB_PEDI_QTDE_SOLIC, @VDB_PEDI_QTDE_CANC
END
CLOSE CUR_PED_PROD2
DEALLOCATE CUR_PED_PROD2
SET @V_DESCONTO_MEDIO_PEDIDO = (1 - (@V_VALOR_LIQ_TOTAL_DESCONTOS / @V_VALOR_BRU_TOTAL)) * 100;
SET @V_DESCONTO_PED_ITEM = @V_DESCONTO_ITEM
IF @V_DESCONTO_PED_ITEM > @V_DB_ALCP_DCTOMAXJUSTIF
SET @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
IF (  @V_DESCONTO_ITEM  >  @VDB_ALCP_DESCTOMEDIO)
BEGIN
SET @V_FLG = 1;
BREAK;
END;
END
END
END
SELECT @V_POL_INDDESCCABMOTDESOBRIG_LIB = ISNULL(DB_PRMS_VALOR, '')
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'POL_INDDESCCABMOTDESOBRIG_LIB';
IF ISNULL(@V_POL_INDDESCCABMOTDESOBRIG_LIB, '') <> ''
BEGIN
SET @V_VALIDA_DESCONTO = 0;
SET @V_TEMP_COUNT = 1
WHILE (@V_TEMP_COUNT <= LEN(@V_POL_INDDESCCABMOTDESOBRIG_LIB))
BEGIN
SELECT TOP 1 @V_VALIDA_DESCONTO = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO
WHERE PEDIDO = @P_NRO
AND APLICACAO = 'C'
AND (INDICE_DESCONTO = DBO.MERCF_PIECE(@V_POL_INDDESCCABMOTDESOBRIG_LIB, ',', @V_TEMP_COUNT)
AND DBO.MERCF_PIECE(@V_POL_INDDESCCABMOTDESOBRIG_LIB, ',', @V_TEMP_COUNT) <> '')
AND ISNULL(MOTIVO_INVESTIMENTO, 0) = 0
IF @V_VALIDA_DESCONTO = 1
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar solicitação de investimento nos descontos da capa para liberar o pedido.';
SET @V_SAI = 1
SET @V_FLG = 1;
BREAK;
END
SET @V_TEMP_COUNT = @V_TEMP_COUNT + 1;
END
SET @V_SOLICITACAO_BLOQUEADA = 0;
SELECT TOP 1 @V_SOLICITACAO_BLOQUEADA = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO, DB_SOLIC_INVESTIMENTO
WHERE DB_PEDIDO_MOTIVO_INVESTIMENTO.PEDIDO = @P_NRO
AND DB_PEDIDO_MOTIVO_INVESTIMENTO.SOLICITACAO_INVESTIMENTO = DB_SOLIC_INVESTIMENTO.NUMERO
AND DB_SOLIC_INVESTIMENTO.SITUACAO = 0
IF @V_SOLICITACAO_BLOQUEADA = 1
BEGIN
SET @P_ERROLIMVERBA = 'Não pode ser liberado porque está vinculado a solicitações de investimento bloqueadas.';
SET @V_SAI = 1
SET @V_FLG = 1;
BREAK;
END
END
SELECT @V_POL_INDDESCTOITMOTDESOBRIG_LIB = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'POL_INDDESCTOITMOTDESOBRIG_LIB';
IF ISNULL(@V_POL_INDDESCTOITMOTDESOBRIG_LIB, '') <> ''
BEGIN
SET @V_TEMP_COUNT = 1;
WHILE (@V_TEMP_COUNT <= LEN(@V_POL_INDDESCTOITMOTDESOBRIG_LIB))
BEGIN
SELECT TOP 1 @V_VALIDA_DESCONTO = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO
WHERE PEDIDO = @P_NRO
AND (ITEM < 1000 AND ITEM <> 0)
AND APLICACAO = 'I'
AND (INDICE_DESCONTO = DBO.MERCF_PIECE(@V_POL_INDDESCTOITMOTDESOBRIG_LIB, ',', @V_TEMP_COUNT)
AND DBO.MERCF_PIECE(@V_POL_INDDESCTOITMOTDESOBRIG_LIB, ',', @V_TEMP_COUNT) <> '')
AND ISNULL(MOTIVO_INVESTIMENTO, 0)  = 0;
IF  @V_VALIDA_DESCONTO = 1
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar solicitação de investimento nos descontos dos itens para liberar o pedido.';
SET @V_SAI = 1
SET @V_FLG = 1;
BREAK
END
SET @V_TEMP_COUNT = @V_TEMP_COUNT + 1;
END
SET @V_SOLICITACAO_BLOQUEADA = 0;
SELECT TOP 1 @V_SOLICITACAO_BLOQUEADA = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO, DB_SOLIC_INVESTIMENTO
WHERE DB_PEDIDO_MOTIVO_INVESTIMENTO.PEDIDO = @P_NRO
AND DB_PEDIDO_MOTIVO_INVESTIMENTO.SOLICITACAO_INVESTIMENTO = DB_SOLIC_INVESTIMENTO.NUMERO
AND DB_SOLIC_INVESTIMENTO.SITUACAO = 0
IF @V_SOLICITACAO_BLOQUEADA = 1
BEGIN
SET @P_ERROLIMVERBA = 'Não pode ser liberado porque está vinculado a solicitações de investimento bloqueadas.';
SET @V_SAI = 1
SET @V_FLG = 1;
BREAK;
END
END
SELECT @V_POL_DESCTOINVEST_LIB = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'POL_DESCTOINVEST_LIB';
IF @V_POL_DESCTOINVEST_LIB = 1
BEGIN
SET @V_VALIDA_DESCONTO = 0;
SELECT TOP 1 @V_VALIDA_DESCONTO = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO
WHERE PEDIDO = @P_NRO
AND ITEM = 0
AND ISNULL(SOLICITACAO_INVESTIMENTO, 0) = 0
IF @V_VALIDA_DESCONTO = 1
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar solicitação de investimento nos descontos de investimento liberar o pedido.
';
SET @V_SAI = 1
SET @V_FLG = 1;
BREAK
END
SET @V_SOLICITACAO_BLOQUEADA = 0;
SELECT TOP 1 @V_SOLICITACAO_BLOQUEADA = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO, DB_SOLIC_INVESTIMENTO
WHERE DB_PEDIDO_MOTIVO_INVESTIMENTO.PEDIDO = @P_NRO
AND DB_PEDIDO_MOTIVO_INVESTIMENTO.SOLICITACAO_INVESTIMENTO = DB_SOLIC_INVESTIMENTO.NUMERO
AND DB_SOLIC_INVESTIMENTO.SITUACAO = 0
IF @V_SOLICITACAO_BLOQUEADA = 1
BEGIN
SET @P_ERROLIMVERBA = 'Não pode ser liberado porque está vinculado a solicitações de investimento bloqueadas.';
SET @V_SAI = 1
SET @V_FLG = 1;
BREAK;
END
END
END
SET @V_PASSO = 14;
IF @V_SAI = 1
BEGIN
ROLLBACK
RETURN
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX, 1) = 'F'
BEGIN
IF @V_TBOPS_FAT = 'B'
BEGIN
IF (ISNULL(@V_LIB_BONMAX, 0) <> 999.99 AND ISNULL(@V_LIB_BONMAX, 0) > 0)
OR (@V_BON_TOT > @V_LIB_BONMAX_VLR AND @V_LIB_BONMAX_VLR > 0)
SET @V_FLG = 1;
END
ELSE
IF (@V_BON_PERC > @V_LIB_BONMAX AND @V_LIB_BONMAX > 0)
OR (@V_BON_TOT > @V_LIB_BONMAX_VLR AND @V_LIB_BONMAX_VLR > 0)
SET @V_FLG = 1;
SELECT @V_POL_BONIMOTIVOBRIG_LIB = ISNULL(DB_PRMS_VALOR, 0)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'POL_BONIMOTIVOBRIG_LIB';
IF @V_POL_BONIMOTIVOBRIG_LIB = 1
BEGIN
SET @V_MOTIVO_INVESTIMENTO = 0
SELECT TOP 1 @V_MOTIVO_INVESTIMENTO = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO  MOTINV
, DB_PEDIDO_PROD                 PEDPROD
WHERE MOTINV.PEDIDO = @P_NRO
AND ISNULL(MOTINV.MOTIVO_INVESTIMENTO, 0) = 0
AND MOTINV.PEDIDO   = PEDPROD.DB_PEDI_PEDIDO
AND MOTINV.ITEM     = PEDPROD.DB_PEDI_SEQUENCIA
AND DB_PEDI_TIPO    = 'B'
IF @V_MOTIVO_INVESTIMENTO = 1
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar solicitação de investimento nos itens de bonificação liberar o pedido.';
SET @V_SAI = 1
SET @V_FLG = 1;
END
ELSE
BEGIN
SET @V_SOLICITACAO_BLOQUEADA = 0;
SELECT TOP 1 @V_SOLICITACAO_BLOQUEADA = 1
FROM DB_PEDIDO_MOTIVO_INVESTIMENTO, DB_SOLIC_INVESTIMENTO
WHERE DB_PEDIDO_MOTIVO_INVESTIMENTO.PEDIDO = @P_NRO
AND DB_PEDIDO_MOTIVO_INVESTIMENTO.SOLICITACAO_INVESTIMENTO = DB_SOLIC_INVESTIMENTO.NUMERO
AND DB_SOLIC_INVESTIMENTO.SITUACAO = 0
IF @V_SOLICITACAO_BLOQUEADA = 1
BEGIN
SET @P_ERROLIMVERBA = 'Não pode ser liberado porque está vinculado a solicitações de investimento bloqueadas.';
SET @V_SAI = 1
SET @V_FLG = 1;
END
END
END
SET @V_VERIFICA_MOTIVO_BLOQ78 = 0;
SELECT @V_VERIFICA_MOTIVO_BLOQ78 = 1
FROM DB_PEDIDO_MOTBLOQ
WHERE DB_PEDM_PEDIDO = @P_NRO
AND DBO.MERCF_VALIDA_LISTA(78, REPLACE(DB_PEDM_IDBLOQ, ';', ','), 0, ',') = 1
AND ISNULL(DB_PEDM_IDBLOQ, '') <> '';
IF @V_VERIFICA_MOTIVO_BLOQ78 = 1
BEGIN
SET @V_URL = ''
SELECT @V_URL = 'http:' + SUBSTRING(DB_PRMS_VALOR,  CHARINDEX('//', DB_PRMS_VALOR), LEN(DB_PRMS_VALOR)) + '/Services/WSCalculos.svc/SaldoVerbaBonificacao'
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'SIS_ENDERECOMERCANETWEB';
SET @V_JSON = '"{ PEDIDO : ';
SET @V_JSON = @V_JSON + '' + CAST(@P_NRO AS VARCHAR) + '';
SET @V_JSON = @V_JSON + ' } " ';
EXEC sp_OACreate 'MSXML2.ServerXMLHTTP', @VPOINTER OUTPUT
EXEC sp_OAMethod @VPOINTER, 'open', NULL, 'POST', @V_URL
EXEC sp_OAMethod @VPOINTER, 'setRequestHeader', null, 'Content-Type', 'application/json'
EXEC sp_OAMethod @VPOINTER, 'send', null, @V_JSON
EXEC sp_OAMethod @VPOINTER, 'responseText' , @VRESPONSETEXT OUTPUT
EXEC sp_OAMethod @VPOINTER, 'Status', @VSTATUS OUTPUT
EXEC sp_OAMethod @VPOINTER, 'StatusText', @VSTATUSTEXT OUTPUT
EXEC sp_OADestroy @VPOINTER
IF @VSTATUS = 200
BEGIN
SET @VRESPONSETEXT = REPLACE(@VRESPONSETEXT, '"', '')
IF ISNULL(DBO.MERCF_PIECE(@VRESPONSETEXT, '|', 1), '')  <> ''
BEGIN
SET @P_ERROLIMVERBA = DBO.MERCF_PIECE(@VRESPONSETEXT, '|', 1)
SET @V_SAI = 1
ROLLBACK
RETURN
END
ELSE
BEGIN
UPDATE DB_PEDIDO_PROD
SET DB_PEDI_VISAO = DBO.MERCF_PIECE(@VRESPONSETEXT, '|', 2),
DB_PEDI_PERIODO = DBO.MERCF_PIECE(@VRESPONSETEXT, '|', 3)
WHERE DB_PEDI_PEDIDO = @P_NRO
AND DB_PEDI_TIPO = 'B'
END
END
END
END
SET @V_PASSO = 15;
IF @V_SAI = 1
BEGIN
ROLLBACK
RETURN
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'L'
BEGIN
IF @V_FORMA_AVALIA_LUCRA = 1
BEGIN
SET @V_VALIDA_BLOQ_93 = 0
SELECT TOP 1 @V_VALIDA_BLOQ_93 = 1
FROM DB_PEDIDO_MOTBLOQ
WHERE DB_PEDM_PEDIDO = @P_NRO
AND DBO.MERCF_VALIDA_LISTA(93, REPLACE(DB_PEDM_IDBLOQ, ';', ','), 0, ',') = 1
AND ISNULL(DB_PEDM_IDBLOQ, '') <> ''
IF @V_VALIDA_BLOQ_93 = 1
BEGIN
SET @V_VALIDA_BLOQ_93 = 0
SELECT TOP 1 @V_VALIDA_BLOQ_93 = 1
FROM DB_PEDIDO_PROD
WHERE DB_PEDI_PEDIDO = @P_NRO
AND ISNULL(DB_PEDI_BLOQLUC, 0) = 1
AND DB_PEDI_PERC_MLUCR < @V_PERCMINIMO_LUCR_ITEM
SET @V_LIMPA_BLOQ_L_ITENS = 1
IF @V_VALIDA_BLOQ_93 = 1
BEGIN
SET @V_FLG = 1;
SET @V_LIMPA_BLOQ_L_ITENS = 0
END
ELSE
BEGIN
IF @VDB_PEDC_BLOQLUC = 1
SET @V_FLG = 1;
END
END
ELSE
BEGIN
IF @VDB_PEDC_BLOQLUC = 1
SET @V_FLG = 1;
END
END
ELSE
BEGIN
SET @V_LIMPA_BLOQ_L_PEDIDO = 1
IF @V_LUCRATIVIDADE < @V_USU_PERCMINIMO_LUCR
BEGIN
SET @V_FLG = 1;
SET @V_LIMPA_BLOQ_L_PEDIDO = 0
END
ELSE
BEGIN
SET @V_VALIDA_BLOQ_93 = 0
SELECT TOP 1 @V_VALIDA_BLOQ_93 = 1
FROM DB_PEDIDO_PROD
WHERE DB_PEDI_PEDIDO = @P_NRO
AND ISNULL(DB_PEDI_BLOQLUC, 0) = 1
IF @V_VALIDA_BLOQ_93 = 1
BEGIN
SET @V_FLG = 1;
END
END
END
IF @V_LIMPA_BLOQ_L_PEDIDO = 1
BEGIN
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_BLOQLUC = 0
WHERE DB_PEDC_NRO = @P_NRO
END
IF @V_LIMPA_BLOQ_L_ITENS = 1
BEGIN
UPDATE DB_PEDIDO_PROD
SET DB_PEDI_BLOQLUC = 0
WHERE DB_PEDI_PEDIDO = @P_NRO
END
END
SET @V_PASSO = '16';
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'V'
BEGIN
SET @V_TIPO_AGRUPAMENTO = 0;
SELECT TOP 1 @V_TIPO_AGRUPAMENTO = TIPO_AGRUPAMENTO
FROM DB_BLOQ_V_AGRUPAMENTO
SELECT TOP 1 @VDB_PEDM_AGRUPAMENTO		  = DB_PEDM_AGRUPAMENTO ,
@VDB_PEDM_VALOR_AGRUPAMENTO  = DB_PEDM_VALOR_AGRUPAMENTO
FROM DB_PEDIDO_MOTBLOQ
WHERE DB_PEDM_PEDIDO = @P_NRO
AND DB_PEDM_IDBLOQ LIKE '%83%'
SET @V_COUNT_AGRUPAMENTOS = 1;
SET @V_NUMERO_AGRUPAMENTOS = 0;
IF ISNULL(@VDB_PEDM_AGRUPAMENTO, '') <> ''
SET @V_NUMERO_AGRUPAMENTOS = (LEN(@VDB_PEDM_AGRUPAMENTO) - LEN(REPLACE(@VDB_PEDM_AGRUPAMENTO,';',''))) + 1
WHILE(@V_COUNT_AGRUPAMENTOS <= @V_NUMERO_AGRUPAMENTOS)
BEGIN
SET @V_AGRUPAMENTO = DBO.MERCF_PIECE(@VDB_PEDM_AGRUPAMENTO, ';', @V_COUNT_AGRUPAMENTOS)
SET @V_VALOR_AGRUPAMENTO_MINIMO = DBO.MERCF_PIECE(@VDB_PEDM_VALOR_AGRUPAMENTO, ';', @V_COUNT_AGRUPAMENTOS)
SELECT @V_TOTAL_AGRUPAMENTO = ISNULL(SUM(VALORES.PRECO)/ SUM(VALORES.PESO), 0)
FROM(
SELECT ((((DB_PEDI_PRECO_LIQ -
((DB_PEDI_PRECO_LIQ * (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC) *
(CASE WHEN DB_PROD_NTRIBPISC = 0
THEN
ISNULL((SELECT TOP 1 DB_TBOPSP_PERC
FROM DB_TB_OPERS_PERC
WHERE DB_TBOPSP_COD = DB_PEDI_OPERACAO
AND DB_TBOPSP_IMPOSTO = 2
AND (( DB_TBOPSP_DT_INI <= DB_PED_DT_EMISSAO AND DB_TBOPSP_DT_FIN >= DB_PED_DT_EMISSAO)
OR (ISNULL(DB_TBOPSP_DT_INI, '') = '' OR ISNULL(DB_TBOPSP_DT_FIN, '') = ''))), 0)
ELSE 0 END   / 100)) +
(DB_PEDI_PRECO_LIQ * (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC) *
(CASE WHEN DB_PROD_NTRIBPISC = 0
THEN
ISNULL((SELECT TOP 1 DB_TBOPSP_PERC
FROM DB_TB_OPERS_PERC
WHERE DB_TBOPSP_COD = DB_PEDI_OPERACAO
AND DB_TBOPSP_IMPOSTO = 1
AND (( DB_TBOPSP_DT_INI <= DB_PED_DT_EMISSAO AND DB_TBOPSP_DT_FIN >= DB_PED_DT_EMISSAO)
OR (ISNULL(DB_TBOPSP_DT_INI, '') = '' OR ISNULL(DB_TBOPSP_DT_FIN, '') = ''))), 0)
ELSE 0 END  / 100)) +
(DB_PEDI_PRECO_LIQ * (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC) *
(CASE WHEN (DB_PEDI_ICMSDSCTO = 1 OR (ISNULL((SELECT DB_TBOPS_TRIB_ICMS FROM DB_TB_OPERS WHERE DB_TBOPS_COD = '4'), 1) = 1))
THEN 0
ELSE DB_PEDI_ICMSDEST END  / 100)) ) / (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC)
- (DB_PEDI_VLR_FRETIT - DB_PEDIDO_PROD.DB_PEDI_VLR_DESCARGA))	/ DB_PROD_PESO_BRU)  * 1000) * (DB_PROD_PESO_BRU * (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC)) )  PRECO,
(DB_PROD_PESO_BRU * (DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC))   PESO
FROM DB_PEDIDO, DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PRODUTO = DB_PROD_CODIGO
AND DB_PED_NRO = DB_PEDI_PEDIDO
AND DB_PEDI_PEDIDO = @P_NRO
AND (CASE @V_TIPO_AGRUPAMENTO
WHEN 1
THEN CASE WHEN DB_PROD_CODIGO = @V_AGRUPAMENTO THEN 1 ELSE 0 END
WHEN 2
THEN CASE WHEN DB_PROD_TPPROD = @V_AGRUPAMENTO THEN 1 ELSE 0 END
WHEN 3
THEN CASE WHEN DB_PROD_MARCA = @V_AGRUPAMENTO THEN 1 ELSE 0 END
WHEN 4
THEN CASE WHEN DB_PROD_FAMILIA = @V_AGRUPAMENTO THEN 1 ELSE 0 END
ELSE 0
END) = 1
)AS VALORES
IF (100 - (( @V_TOTAL_AGRUPAMENTO / CAST(REPLACE(@V_VALOR_AGRUPAMENTO_MINIMO, ',', '.') AS REAL)) * 100 )) > @V_PERCENTUAL_MAXIMO_REDUCAO
BEGIN
SET @V_FLG = 1
BREAK
END
SET @V_COUNT_AGRUPAMENTOS = @V_COUNT_AGRUPAMENTOS + 1
END
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'X'
BEGIN
SELECT @V_LIB_BLOQXDEBITOCONTA = MAX(DB_PRMS_VALOR)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'LIB_BLOQXDEBITOCONTA';
IF @V_LIB_BLOQXDEBITOCONTA = 1
BEGIN
IF ISNULL(@V_DB_PEDC_CONTAINV_SUP, 0) = 0
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar conta de investimento para liberar pelo motivo X.';
SET @V_FLG = 1;
ROLLBACK
RETURN
END
END
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'K'
BEGIN
SET @V_INDICE_DESCTO_FINANCEIRO = 0
SELECT @V_INDICE_DESCTO_FINANCEIRO = DB_PRMS_VALOR
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'PED_INDDCTOFINANC'
IF @V_INDICE_DESCTO_FINANCEIRO <> 0 AND @VDB_ALCP_DCTOMAXVERBA > 0
BEGIN
DECLARE CUR_PED_ITENS_BLOQ_K CURSOR
FOR SELECT DB_PEDI_SEQUENCIA,
DB_PEDI_PRECO_UNIT,
DB_PEDI_PRECO_LIQ,
DB_PEDI_QTDE_SOLIC - DB_PEDI_QTDE_CANC,
round((DB_PEDI_PRECO_LIQ * DB_PEDI_ESTVLR ) +
((DB_PEDI_PRECO_LIQ * DB_PEDI_ESTVLR * isnull(DB_PEDI_IPI, 0) / 100)) +
((DB_PEDI_ESTVLR *
ISNULL(DB_PEDIDO_PROD.DB_PEDI_VLRIPI * DB_PEDI_ESTVLR, 0))) + isnull(DB_PEDI_VLR_SUBST * DB_PEDI_ESTVLR, 0), 2)
FROM DB_PEDIDO_PROD
WHERE DB_PEDI_PEDIDO = @P_NRO
and DB_PEDI_BLOQVERBA = 1
OPEN CUR_PED_ITENS_BLOQ_K
FETCH NEXT FROM CUR_PED_ITENS_BLOQ_K
INTO @V_SEQ_ITEM_BLOQ_K, @V_PRECO_BRUTO_K, @V_PRECO_LIQUIDO_K, @V_QUANTIDADE_K, @V_PRECO_COM_IMPOSTOS_K
WHILE @@FETCH_STATUS = 0
BEGIN
SELECT @V_DESCONTO_CALCULADO	 = DB_PEDD_DCTOPOL,
@V_DESCONTO_APLICADO		 = DB_PEDD_DESCONTO,
@V_BASE_DESCTO_FINANCEIRO = ISNULL(DB_PEDD_BASEDESCTOFINANC, 0),
@V_VALOR_INIT_DESC_FINAN  = DB_PEDD_VALOR_UNITARIO
FROM DB_PEDIDO_DESCONTO
WHERE DB_PEDD_NRO = @P_NRO
AND DB_PEDD_TPDESC  = 0
AND DB_PEDD_SEQIT = @V_SEQ_ITEM_BLOQ_K
AND DB_PEDD_INDDESCTO = @V_INDICE_DESCTO_FINANCEIRO
IF @V_DESCONTO_CALCULADO <> 0 OR @V_DESCONTO_APLICADO <> 0
BEGIN
IF @V_BASE_DESCTO_FINANCEIRO = 0
SET @V_VALOR_BASE = @V_PRECO_LIQUIDO_K;
ELSE IF @V_BASE_DESCTO_FINANCEIRO = 1
SET @V_VALOR_BASE = @V_PRECO_COM_IMPOSTOS_K;
ELSE IF @V_BASE_DESCTO_FINANCEIRO = 2
SET @V_VALOR_BASE = @V_PRECO_BRUTO_K;
SET @V_PRECO_APLICADO_TOTAL = (@V_PRECO_BRUTO_K - @V_VALOR_INIT_DESC_FINAN) * @V_QUANTIDADE_K
SET @V_PRECO_TOTAL_POLITICA = ( @V_PRECO_BRUTO_K - ((@V_VALOR_BASE * @V_DESCONTO_CALCULADO) / 100 )) * @V_QUANTIDADE_K
SET @V_ECONOMIA_ITEM = @V_PRECO_APLICADO_TOTAL - @V_PRECO_TOTAL_POLITICA
IF ((@V_ECONOMIA_ITEM * 100) / (@V_PRECO_APLICADO_TOTAL - @V_ECONOMIA_ITEM)) * (-1)  > @VDB_ALCP_DCTOMAXVERBA
BEGIN
SET @V_FLG = 1;
BREAK;
END
END
FETCH NEXT FROM CUR_PED_ITENS_BLOQ_K
INTO @V_SEQ_ITEM_BLOQ_K, @V_PRECO_BRUTO_K, @V_PRECO_LIQUIDO_K, @V_QUANTIDADE_K, @V_PRECO_COM_IMPOSTOS_K
END
CLOSE CUR_PED_ITENS_BLOQ_K
DEALLOCATE CUR_PED_ITENS_BLOQ_K
END
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'T'
BEGIN
IF @VDB_ALCP_VLRMAXTPPED > 0 AND @V_PED_TOT > @VDB_ALCP_VLRMAXTPPED
BEGIN
SET @V_FLG = 1;
END
END
IF (SUBSTRING(@V_MOTIVOS, @V_AUX, 1) = 'A' AND NOT  ( @V_FLG_LIB_MOTIVO_A_ALCADA = 1 AND @V_FLG_LIB_MOTIVO_A_PGTO = 1) ) OR SUBSTRING(@V_MOTIVOS, @V_AUX, 1) <> 'A'
BEGIN
IF @V_LIBERA_PEDIDO = 0
BEGIN
IF (@V_VLR_PED > @V_VLR_MAX) AND NOT (@V_FLG = 0 AND @V_LIB_LIMITEEXCEDIDO = 1)
SET @V_FLG = 1;
ELSE IF (@V_VLR_PED < @V_VLR_MAX) AND (@V_LIB_LIMITEEXCEDIDO = 1)
SET @V_FLG = 1;
END
IF @V_LIBERA_PEDIDO = 1
BEGIN
IF @V_TOTAL_PEDIDOS_EM_ABERTO > @V_VLR_MAX
SET @V_FLG = 1;
END
IF @V_LIBERA_PEDIDO = 2
BEGIN
IF @V_TOTAL_COBRANCA_CLIENTE > @V_VLR_MAX
SET @V_FLG = 1;
END
IF @V_LIBERA_PEDIDO = 3
BEGIN
IF (@V_TOTAL_PEDIDOS_EM_ABERTO + @V_TOTAL_COBRANCA_CLIENTE) > @V_VLR_MAX
SET @V_FLG = 1;
END
END
SET @V_PASSO = '17';
IF @V_FLG = 0
SET @V_LIBMOTS = @V_LIBMOTS + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
ELSE
BEGIN
IF SUBSTRING(@V_MOTIVOS, @V_AUX, 1) = 'E'
BEGIN
DECLARE CUR_DOC CURSOR
FOR SELECT SEQUENCIA
FROM DB_PEDIDO_DOC_BLOQ
WHERE PEDIDO = @P_NRO
AND ISNULL(DATA_LIBERACAO, '') = ''
AND (ISNULL(@DB_ALCP_LSTTIPODOC , '') LIKE  CAST(DOCUMENTO  AS VARCHAR)  + ',%'
OR ISNULL(@DB_ALCP_LSTTIPODOC , '') LIKE '%,' + CAST(DOCUMENTO AS VARCHAR) + ',%'
OR ISNULL(@DB_ALCP_LSTTIPODOC , '') LIKE  '%,' + CAST(DOCUMENTO  AS VARCHAR)
OR ISNULL(@DB_ALCP_LSTTIPODOC , '') = CAST(DOCUMENTO  AS VARCHAR)
OR ISNULL(@DB_ALCP_LSTTIPODOC , '') = '')
OPEN CUR_DOC
FETCH NEXT FROM CUR_DOC
INTO @V_SEQ_DOC
WHILE @@FETCH_STATUS = 0
BEGIN
UPDATE DB_PEDIDO_DOC_BLOQ
SET USUARIO_LIBERACAO = @P_USUARIO,
DATA_LIBERACAO    = GETDATE()
WHERE PEDIDO = @P_NRO
AND SEQUENCIA = @V_SEQ_DOC;
FETCH NEXT FROM CUR_DOC
INTO @V_SEQ_DOC
END
CLOSE CUR_DOC
DEALLOCATE CUR_DOC
SET @V_EXISTE_DOC_BLOQ = 0;
SELECT TOP 1 @V_EXISTE_DOC_BLOQ = 1
FROM DB_PEDIDO_DOC_BLOQ
WHERE PEDIDO = @P_NRO
AND ISNULL(DATA_LIBERACAO, '') = '';
IF @V_EXISTE_DOC_BLOQ = 1
BEGIN
SET @V_FLG = 1;
END
ELSE
BEGIN
SET @V_LIBMOTS = @V_LIBMOTS + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'X'
BEGIN
SELECT @V_LIB_BLOQXDEBITOCONTA = MAX(DB_PRMS_VALOR)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'LIB_BLOQXDEBITOCONTA';
IF @V_LIB_BLOQXDEBITOCONTA = 1
BEGIN
IF ISNULL(@V_DB_PEDC_CONTAINV_SUP, 0) = 0
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar conta de investimento para liberar pelo motivo X.';
SET @V_FLG = 1;
ROLLBACK
RETURN
END
ELSE
BEGIN
SET @V_LIBMOTS = @V_LIBMOTS + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
END
END
END
ELSE
BEGIN
SET @V_PASSO = '18';
SET @V_LIBMOTS = @V_LIBMOTS + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
END
IF SUBSTRING(@V_MOTIVOS, @V_AUX,1) = 'X'
BEGIN
SELECT @V_LIB_BLOQXDEBITOCONTA = MAX(DB_PRMS_VALOR)
FROM DB_PARAM_SISTEMA
WHERE DB_PRMS_ID = 'LIB_BLOQXDEBITOCONTA';
IF @V_LIB_BLOQXDEBITOCONTA = 1
BEGIN
IF ISNULL(@V_DB_PEDC_CONTAINV_SUP, 0) = 0
BEGIN
SET @P_ERROLIMVERBA = 'Obrigatório informar conta de investimento para liberar pelo motivo X.';
SET @V_FLG = 1;
ROLLBACK
RETURN
END
ELSE
BEGIN
SELECT @V_VALOR_LANCAMENTO = SUM(VALORES.VALOR_LANCAMENTO)
FROM (
SELECT CASE WHEN    PEDMOT_IT.ITEM > 0
AND PEDMOT_IT.ITEM < 1000
AND PED.DB_PED_FATUR <> 2
THEN	ROUND(PEDMOT_IT.VALOR * (PEDPROD.DB_PEDI_QTDE_SOLIC - PEDPROD.DB_PEDI_QTDE_CANC), 2)
WHEN (  PEDMOT_IT.ITEM > 1000
AND PEDMOT_IT.ITEM < 2000)
OR (PED.DB_PED_FATUR = 2)
THEN	ROUND(PEDMOT_IT.VALOR * PEDMOT_IT.QUANTIDADE, 2)
WHEN PEDMOT_IT.APLICACAO = 'V'
THEN ROUND(PEDMOT_IT.VALOR, 2)
END    VALOR_LANCAMENTO
FROM DB_PEDIDO                      PED          WITH (NOLOCK)
, DB_PEDIDO_PROD                 PEDPROD      WITH (NOLOCK)
, DB_PEDIDO_MOTIVO_INVESTIMENTO  PEDMOT_IT    WITH (NOLOCK)
, DB_MOTIVO_INVEST_DESCTO        MOTDESC
WHERE PED.DB_PED_NRO                = @P_NRO
AND PED.DB_PED_NRO                = PEDPROD.DB_PEDI_PEDIDO
AND PEDPROD.DB_PEDI_SEQUENCIA     = PEDMOT_IT.ITEM
AND PED.DB_PED_NRO                = PEDMOT_IT.PEDIDO
AND PEDMOT_IT.MOTIVO_INVESTIMENTO =  MOTDESC.CODIGO
AND ISNULL(MOTDESC.BLOQUEIA_PEDIDO, 0) = 1
AND PEDMOT_IT.APLICACAO           NOT IN ('V')
AND PEDPROD.DB_PEDI_SITUACAO     <> 9
UNION ALL
SELECT ROUND(PEDMOT_CAB.VALOR, 2)   VALOR_LANCAMENTO
FROM DB_PEDIDO                      PED            WITH (NOLOCK)
, DB_PEDIDO_MOTIVO_INVESTIMENTO  PEDMOT_CAB     WITH (NOLOCK)
, DB_MOTIVO_INVEST_DESCTO        MOTDESC        WITH (NOLOCK)
WHERE PED.DB_PED_NRO                = @P_NRO
AND PEDMOT_CAB.PEDIDO             = PED.DB_PED_NRO
AND PEDMOT_CAB.APLICACAO          = 'V'
AND PEDMOT_CAB.MOTIVO_INVESTIMENTO =  MOTDESC.CODIGO
AND ISNULL(MOTDESC.BLOQUEIA_PEDIDO, 0) = 1
)   AS VALORES;
EXEC DBO.MERCP_BUSCA_SEQUENCIA_SQL 'SEQ_DB_CC_LANCAMENTOS', @V_SEQ_LANCAMENTOS OUT
INSERT INTO DB_CC_LANCAMENTOS (CODIGO
, TIPO
, DATA_LANCAMENTO
, DATA_VIGENCIA
, VALOR
, CONTA_CORRENTE
, CLIENTE
, REPRESENTANTE
, DESCRICAO
, PEDIDO
, OCORRENCIA
, DATA_REGISTRO
, USUARIO_REGISTRO
, CONTRATO
, SEQUENCIA_DOCUMENTO)
VALUES (@V_SEQ_LANCAMENTOS
, 2
, GETDATE()
, GETDATE()
, ISNULL(@V_VALOR_LANCAMENTO, 0)  * -1
, CAST(@V_DB_PEDC_CONTAINV_SUP AS VARCHAR) + '-1'
, @V_PED_CLIENTE
, @V_PED_REPRES
, 'Investimento liberado por ' + @P_USUARIO + ' para pedido ' + cast(@P_NRO as varchar)
, @P_NRO
, 0
, GETDATE()
, @P_USUARIO
, 0
, 0
);
END;
END;
END;
SET @V_PASSO = '19';
END
END
IF @V_SAI = 1
BEGIN
ROLLBACK
RETURN
END
IF @V_SAI = 1
BEGIN
ROLLBACK
RETURN
END
SET @V_MOTIVOS = @V_LIBMOTS;
SET @V_LIBMOTS = '';
SET @V_PASSO = '20';
SET @V_AUX = 0;
IF ISNULL(@V_MOTIVOS, '') <> ''
WHILE @V_AUX < LEN(@V_MOTIVOS)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTIVOS, @V_AUX, 1), ISNULL(@V_BLQS,' ')) = 0
SET @V_LIBMOTS = @V_LIBMOTS + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
IF @P_RECALCULAMOTBLOQP = 1 AND CHARINDEX('A', @V_LIBMOTS) > 0
BEGIN
IF CHARINDEX('P', @V_LIBMOTS) = 0
SET @V_LIBMOTS = @V_LIBMOTS + 'P'
INSERT INTO DB_PEDIDO_LOG (DB_PEDL_NRO,
DB_PEDL_SEQ,
DB_PEDL_DATA ,
DB_PEDL_LOG )
VALUES(
@P_NRO,
(SELECT ISNULL(MAX(DB_PEDL_SEQ), 0) + 1 FROM DB_PEDIDO_LOG WHERE DB_PEDL_NRO = @P_NRO),
GETDATE(),
SUBSTRING('Pedido ' + CAST(@P_NRO AS VARCHAR) + ' foi liberado pelo motivo P (ID 92), mesmo com datas inválidas. Data de emissão: ' + CONVERT(VARCHAR(10), @V_DB_PED_DT_EMISSAO, 103) + '. Previsão de entrega ' + CONVERT(VARCHAR(10), @VDB_PEDC_PREV_FAT, 103) + '. Usuário que liberou: ' + @P_USUARIO + '. Data de liberação: ' + (CONVERT(VARCHAR(10), GETDATE(), 103) + ' '  + CONVERT(VARCHAR(8), GETDATE(), 14)) +'.', 1, 255)
)
END
ELSE
IF @P_RECALCULAMOTBLOQP = 0 AND @V_PED_RECALCULAMOTBLOQP = 1 AND CHARINDEX('A', @V_LIBMOTS) > 0
BEGIN
SELECT @V_DATA3 = CONVERT(DATE, DBO.MERCF_PIECE(@P_DATAS_CALCULADAS, ';', 3), 103)
IF CONVERT(DATE, @V_DATA3, 103) > CONVERT(DATE, @VDB_PEDC_PREV_FAT, 103)
BEGIN
UPDATE DB_PEDIDO SET DB_PED_MOTIVO_BLOQ = SUBSTRING(@V_DB_PED_MOTIVO_BLOQ_ALL, 1, 12) + 'P' + SUBSTRING(@V_DB_PED_MOTIVO_BLOQ_ALL, 14, 15) WHERE DB_PED_NRO = @P_NRO
UPDATE DB_PEDIDO_MOTBLOQ SET DB_PEDM_IDBLOQ = DB_PEDM_IDBLOQ + ';92' WHERE DB_PEDM_PEDIDO = @P_NRO
INSERT INTO DB_PEDIDO_LOG (DB_PEDL_NRO,
DB_PEDL_SEQ,
DB_PEDL_DATA ,
DB_PEDL_LOG )
VALUES(
@P_NRO,
(SELECT ISNULL(MAX(DB_PEDL_SEQ), 0) + 1 FROM DB_PEDIDO_LOG WHERE DB_PEDL_NRO = @P_NRO),
GETDATE(),
SUBSTRING('Pedido ' + CAST(@P_NRO AS VARCHAR) + ' foi bloqueado pelo motivo P (ID 92), porque possui datas inválidas. Aguarda avaliação das datas para liberação. Data do bloqueio: ' + (CONVERT(VARCHAR(10), GETDATE(), 103) + ' '  + CONVERT(VARCHAR(8), GETDATE(), 14)) + '. Data de emissão: ' + CONVERT(VARCHAR(10), @V_DB_PED_DT_EMISSAO, 103) + '. Previsão de entrega ' + CONVERT(VARCHAR(10), @VDB_PEDC_PREV_FAT, 103) + '.', 1, 255)
)
COMMIT
RETURN
END
END
SET @V_PASSO = '21';
SET @V_MOTIVOS = @V_PED_MOTIVO_BLOQ;
SET @V_LIBTOT =  0;
SET @V_AUX =     0;
IF ISNULL(@V_MOTIVOS, '') <> ''
WHILE @V_AUX < LEN(@V_MOTIVOS)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTIVOS, @V_AUX, 1), (ISNULL(@V_BLQS, ' ') + ISNULL(@V_LIBMOTS,' '))) = 0
SET @V_LIBTOT = 1;
END
SET @V_PASSO = '22';
SET @V_USUS = ISNULL(@V_USUS, '') + @P_USUARIO + '!' + CONVERT(VARCHAR, @V_GRUPO_LIB) + ';';
SET @V_PASSO = '22.1';
SET @V_DATAS = ISNULL(@V_DATAS, '') + CONVERT(VARCHAR, GETDATE(), 103) + ';';
SET @V_PASSO = '22.2';
SET @V_HORAS = ISNULL(@V_HORAS, '') + CONVERT(VARCHAR, GETDATE(), 108) + ';';
SET @V_PASSO = '22.3';
SET @V_BLQS = ISNULL(@V_BLQS, '') + ISNULL(@V_LIBMOTS, '') + ';';
SET @V_PASSO = '23';
IF @V_LIBPARC = 1
BEGIN
SET @V_MOTNLIBERADO = '';
SET @V_AUX = 0;
IF ISNULL(@V_MOTIVOS, '') <> ''
WHILE @V_AUX < LEN(@V_MOTIVOS)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTIVOS, @V_AUX, 1), (ISNULL(@V_BLQS, '') + ISNULL(@V_LIBMOTS, ''))) = 0
SET @V_MOTNLIBERADO = @V_MOTNLIBERADO + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
SET @V_ACHOU_OUTROMOTIVO = 1;
IF @V_GRAVALOG = 1
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR) + ' V_MotNLiberado - ' + isnull(@V_MOTNLIBERADO, 'null'));
END
/***** PASSEI A FAZER ESSA VALIDACAO NO INICIO ****/
SET @V_AUX = 0;
IF ISNULL(@V_MOTNLIBERADO, '') <> ''
BEGIN
WHILE @V_AUX < LEN(@V_MOTNLIBERADO)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF RTRIM(LTRIM(SUBSTRING(@V_MOTNLIBERADO, @V_AUX, 1))) IS NOT NULL
IF CHARINDEX(SUBSTRING(@V_MOTNLIBERADO, @V_AUX, 1), ISNULL(@V_PARAM_MOTIVSLIBER, ' ')) = 0
SET @V_ACHOU_OUTROMOTIVO = 0;
END
IF NOT @V_ACHOU_OUTROMOTIVO = 0
SET @V_LIBTOT = 0;
END
END
SET @V_PASSO = '24';
SET  @V_PASSO = '25';
IF (@V_LIBTOT = 0 AND @V_LIBPARC = 1)
SET @V_UPDATE_SITUACAO = 0;
SET @V_BLOQUEIOS = @V_BLQS;
SET @V_PED_LIB_MOTS = ISNULL(@V_PED_LIB_MOTS, '') + @V_LIBMOTS + ';'
SET @V_PASSO = '26';
SET @V_PASSO = '27';
BEGIN
SELECT @V_PEDAL_SEQ = MAX(DB_PEDAL_SEQ)
FROM DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO;
END
SET @V_PASSO = '28';
SET @V_AUX = 0
IF ISNULL(@V_PERMI, '') <> ''
BEGIN
WHILE @V_AUX < LEN(@V_PERMI)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF  CHARINDEX(SUBSTRING(@V_PERMI, @V_AUX, 1), ISNULL(@V_MOTIVOS, ' ')) > 0
AND CHARINDEX(SUBSTRING(@V_PERMI, @V_AUX, 1), ISNULL(@V_LIBMOTS, ' ')) = 0
AND CHARINDEX(SUBSTRING(@V_PERMI, @V_AUX, 1), ISNULL(@V_PED_LIB_MOTS, ' ')) = 0
SET @V_PEDAL_MOTLIBPAR = ISNULL(@V_PEDAL_MOTLIBPAR, '') + SUBSTRING(@V_PERMI, @V_AUX, 1);
END
END
IF ISNULL(@V_LIBMOTS, '')  <> ''
BEGIN
SET @V_AUX = 0
IF ISNULL(@VDB_PRM_JUST_LIBTOT, '') <> ''
BEGIN
WHILE @V_AUX < LEN(@VDB_PRM_JUST_LIBTOT)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF RTRIM(LTRIM(SUBSTRING(@VDB_PRM_JUST_LIBTOT, @V_AUX, 1))) IS NOT NULL
IF CHARINDEX(SUBSTRING(@VDB_PRM_JUST_LIBTOT, @V_AUX, 1), ISNULL(@V_LIBMOTS, ' ')) > 0
SET @P_MOTIVOREQUERJUSTIFICATIVA = @P_MOTIVOREQUERJUSTIFICATIVA + SUBSTRING(@VDB_PRM_JUST_LIBTOT, @V_AUX, 1);
END
END
END
IF CHARINDEX('D', @VDB_PRM_JUST_LIBTOT) > 0 AND CHARINDEX('D', @V_LIBMOTS) > 0
BEGIN
IF CHARINDEX('D', @P_MOTIVOREQUERJUSTIFICATIVA) = 0
SET @P_MOTIVOREQUERJUSTIFICATIVA = ISNULL(@P_MOTIVOREQUERJUSTIFICATIVA, '') + 'D'
END
ELSE
BEGIN
IF @V_DB_ALCP_DCTOMAXJUSTIF > 0 AND CHARINDEX('D', @V_LIBMOTS) > 0
BEGIN
IF @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
BEGIN
IF CHARINDEX('D', @P_MOTIVOREQUERJUSTIFICATIVA) = 0
SET @P_MOTIVOREQUERJUSTIFICATIVA = ISNULL(@P_MOTIVOREQUERJUSTIFICATIVA, '') + 'D'
END
END
END
IF ISNULL(@V_PEDAL_MOTLIBPAR, '') <> ''
BEGIN
SET @V_AUX = 0
IF ISNULL(@VDB_PRM_JUST_LIBPAR, '') <> ''
BEGIN
WHILE @V_AUX < LEN(@V_MOTIVOS)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTIVOS, @V_AUX, 1), ISNULL(@VDB_PRM_JUST_LIBPAR, ' ')) > 0   BEGIN
SET @V_AUX2 = 0
WHILE @V_AUX2 <  LEN(@V_PERMI)
BEGIN
SET @V_AUX2 = @V_AUX2 + 1
IF CHARINDEX(SUBSTRING(@V_PERMI, @V_AUX2, 1), ISNULL(@VDB_PRM_JUST_LIBPAR, ' ')) > 0 AND SUBSTRING(@V_PERMI, @V_AUX2, 1) = SUBSTRING(@V_MOTIVOS, @V_AUX, 1)
SET @P_MOTIVOREQUERJUSTIFICATIVA = @P_MOTIVOREQUERJUSTIFICATIVA +
SUBSTRING(@VDB_PRM_JUST_LIBPAR,     CHARINDEX(SUBSTRING(@V_PERMI, @V_AUX2, 1), ISNULL(@VDB_PRM_JUST_LIBPAR, ' '))  , 1);
END
END
END
END
END
IF CHARINDEX('D', @VDB_PRM_JUST_LIBPAR) > 0 AND CHARINDEX(@V_PERMI, 'D') > 0 AND CHARINDEX('D', @V_MOTIVOS) > 0
BEGIN
IF CHARINDEX('D', @P_MOTIVOREQUERJUSTIFICATIVA) = 0
SET @P_MOTIVOREQUERJUSTIFICATIVA = ISNULL(@P_MOTIVOREQUERJUSTIFICATIVA, '') + 'D'
END
ELSE
BEGIN
IF @V_DB_ALCP_DCTOMAXJUSTIF > 0 AND CHARINDEX('D', @V_MOTIVOS) > 0 AND CHARINDEX('D', @V_PERMI) > 0
BEGIN
IF @V_EXIGE_JUSTIFICATIVA_MOT_D = 1
BEGIN
IF CHARINDEX('D', @P_MOTIVOREQUERJUSTIFICATIVA) = 0
SET @P_MOTIVOREQUERJUSTIFICATIVA = ISNULL(@P_MOTIVOREQUERJUSTIFICATIVA, '') + 'D'
END
END
END
SET @V_PODE_LIBERAR = 0
IF  ISNULL(@P_MOTIVOREQUERJUSTIFICATIVA, '') = ''
BEGIN
SET @V_PODE_LIBERAR = 1
SET @P_CODIGOJUSTIFICATIVA = NULL;
SET @P_OBSERVACAOJUSTIFICATIVA = NULL;
END
ELSE IF ISNULL(@P_MOTIVOREQUERJUSTIFICATIVA, '') <> '' AND  ISNULL(@P_CODIGOJUSTIFICATIVA, '') <> ''
SET @V_PODE_LIBERAR = 1
IF @V_PODE_LIBERAR = 1
BEGIN
IF @P_EXCLUI = 0
BEGIN
UPDATE DB_PEDIDO
SET DB_PED_LIB_MOTS = @V_PED_LIB_MOTS
, DB_PED_LIB_USUS = @V_USUS
, DB_PED_LIB_DATAS = @V_DATAS
, DB_PED_DATA_ALTER = GETDATE()
, DB_PED_SITUACAO = @V_UPDATE_SITUACAO
WHERE DB_PED_NRO = @P_NRO;
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_AVALIADO   = 0
, DB_PEDC_DEV_PEDREP = 0
, DB_PEDC_LIB_HORAS  = @V_HORAS
, DB_PEDC_DTULTLIB   = GETDATE()
WHERE DB_PEDC_NRO  = @P_NRO;
END
IF (@V_LIBTOT = 0 AND @V_LIBPARC = 1)
BEGIN
UPDATE DB_PEDIDO_ALCADA
SET DB_PEDAL_USULIB  = @V_CODIGO_USUARIO
, DB_PEDAL_MOTLIB  = @V_LIBMOTS
, DB_PEDAL_DATALIB = GETDATE()
, DB_PEDAL_ACAO    = @P_ACAO
, DB_PEDAL_STATUS  = 1
, DB_PEDAL_JUSTIF  = @P_CODIGOJUSTIFICATIVA
, DB_PEDAL_JUSTOBS = @P_OBSERVACAOJUSTIFICATIVA
, DB_PEDAL_JREPRES = @P_REPRESJUSTIFICATIVA
, DB_PEDAL_MOTLIBPAR = @V_PEDAL_MOTLIBPAR
WHERE DB_PEDAL_PEDIDO =  @P_NRO
AND DB_PEDAL_SEQ    =  @V_PEDAL_SEQ;
IF ISNULL(@P_OBSERVACAOJUSTIFICATIVA, '') = ''
SET @V_DESCRICAO = @V_PROGRAMA + ' Liberou pedido total. Pedido nro: ' + CAST(@P_NRO AS VARCHAR);
ELSE
BEGIN
SET @V_DESCRICAO = @V_PROGRAMA + ' Liberou pedido total com justificativa. Pedido nro: ' + CAST(@P_NRO AS VARCHAR);
IF @VLIB_GRAVAJUSTIFICATIVAPED = 1
BEGIN
SET @V_TEMP_MOT_LIB_TOT = ''
IF ISNULL(@V_LIBMOTS, '') <> ''
SET @V_TEMP_MOT_LIB_TOT = @V_LIBMOTS
ELSE
SET @V_TEMP_MOT_LIB_TOT = @V_PEDAL_MOTLIBPAR
INSERT INTO DB_MENSAGEM (DB_MSG_TEXTO,
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_MOTIVO,
DB_MSG_PEDIDO,
DB_MSG_TIPO)
VALUES(
'Motivo ' + ISNULL(@V_TEMP_MOT_LIB_TOT, '') + ': ' + isnull(@P_OBSERVACAOJUSTIFICATIVA, ''),
@V_PED_REPRES,
(SELECT ISNULL(MAX(DB_MSG_SEQUENCIA), 0) + 1 FROM DB_MENSAGEM),
GETDATE(),
@P_USUARIO,
1,
@P_NRO,
5
)
END
END
SET @V_ENV_WORKFLOW = 19;
SET @V_STATUS_PED = 0;
SELECT @V_STATUS_PED = DB_ALCP_STATUS_LT
FROM DB_ALCADA_PED, DB_STATUS
WHERE DB_ALCP_CODIGO = (SELECT DB_PEDAL_ALCADA FROM DB_PEDIDO_ALCADA  WHERE DB_PEDAL_PEDIDO = @P_NRO AND DB_PEDAL_SEQ = @V_PEDAL_SEQ )
AND DB_ALCP_STATUS_LT = DB_STATUS.CODIGO
AND GETDATE() BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_PED <> 0 AND ISNULL(@V_STATUS_PED, '') <> ''
BEGIN
IF @V_STATUS_PED <> @V_STATUS_PED_ATUAL
BEGIN
INSERT INTO DB_MENSAGEM (
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_PEDIDO,
DB_MSG_TEXTO)
VALUES (
@V_PED_REPRES,
ISNULL((SELECT MAX(DB_MSG_SEQUENCIA) FROM DB_MENSAGEM WHERE DB_MSG_REPRES = @V_PED_REPRES), 0) + 1,
GETDATE(),
@P_USUARIO,
@P_NRO,
'Liberação de pedido: novo status do pedido: ' +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED), '[SEM STATUS]') +
'. Status anterior: '  +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED_ATUAL), '[SEM STATUS]')
);
END
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = @V_STATUS_PED
WHERE DB_PEDC_NRO = @P_NRO;
END
ELSE
BEGIN
IF @V_STATUS_PED_ATUAL <> 0 AND ISNULL(@V_STATUS_PED_ATUAL, '') <> ''
BEGIN
SET @V_STATUS_VALIDO = 0;
SELECT @V_STATUS_VALIDO = 1
FROM DB_STATUS
WHERE DB_STATUS.CODIGO = @V_STATUS_PED_ATUAL
AND CAST(GETDATE() AS DATE) BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_VALIDO = 0
BEGIN
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = 0
WHERE DB_PEDC_NRO = @P_NRO;
END
END
END
END
ELSE
BEGIN
UPDATE DB_PEDIDO_ALCADA
SET DB_PEDAL_USULIB  = @V_CODIGO_USUARIO
, DB_PEDAL_DATALIB = GETDATE()
, DB_PEDAL_MOTLIB  = @V_LIBMOTS
, DB_PEDAL_ACAO    = @P_ACAO
, DB_PEDAL_STATUS  = 2
, DB_PEDAL_JUSTIF  = @P_CODIGOJUSTIFICATIVA
, DB_PEDAL_JUSTOBS = @P_OBSERVACAOJUSTIFICATIVA
, DB_PEDAL_JREPRES = @P_REPRESJUSTIFICATIVA
, DB_PEDAL_MOTLIBPAR = @V_PEDAL_MOTLIBPAR
WHERE DB_PEDAL_PEDIDO =  @P_NRO
AND DB_PEDAL_SEQ    =  @V_PEDAL_SEQ;
IF ISNULL(@P_OBSERVACAOJUSTIFICATIVA, '') = ''
SET @V_DESCRICAO = @V_PROGRAMA + ' Liberou pedido parcial. Pedido nro: ' + CAST(@P_NRO AS VARCHAR)
ELSE
BEGIN
SET @V_DESCRICAO = @V_PROGRAMA + ' Liberou pedido parcial com justificativa. Pedido nro: ' +  CAST(@P_NRO AS VARCHAR)
IF @VLIB_GRAVAJUSTIFICATIVAPED = 1
BEGIN
INSERT INTO DB_MENSAGEM (DB_MSG_TEXTO,
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_MOTIVO,
DB_MSG_PEDIDO,
DB_MSG_TIPO)
VALUES(
'Motivo ' + ISNULL(@V_PEDAL_MOTLIBPAR, '') + ': ' + isnull(@P_OBSERVACAOJUSTIFICATIVA, ''),
@V_PED_REPRES,
(SELECT ISNULL(MAX(DB_MSG_SEQUENCIA), 0) + 1 FROM DB_MENSAGEM),
GETDATE(),
@P_USUARIO,
1,
@P_NRO,
5
)
END
END
BEGIN
SET @V_ALCP_GRPALCADA_ANTERIOR = NULL;
SET @V_ALCP_CODIGO_ANTERIOR = NULL;
SET @V_ALCP_GRPLIB_ANTERIOR = NULL;
SET @V_ALCP_NIVLIB_ANTERIOR = NULL;
SELECT  @V_ALCP_GRPALCADA_ANTERIOR = DB_ALCP_GRPALCADA,
@V_ALCP_CODIGO_ANTERIOR = DB_ALCP_CODIGO,
@V_ALCP_GRPLIB_ANTERIOR = DB_ALCP_GRUPOLIB,
@V_ALCP_NIVLIB_ANTERIOR = DB_ALCP_NIVELLIB
FROM DB_ALCADA_PED A, DB_PEDIDO_ALCADA B
WHERE DB_ALCP_CODIGO = DB_PEDAL_ALCADA
AND DB_PEDAL_PEDIDO = @P_NRO
AND DB_PEDAL_SEQ = (SELECT MAX(DB_PEDAL_SEQ) FROM DB_PEDIDO_ALCADA WHERE DB_PEDAL_PEDIDO = @P_NRO)
END
SET @V_PASSO = '30';
BEGIN
DECLARE C	CURSOR
FOR SELECT DB_ALCP_CODIGO
FROM DB_ALCADA_PED
WHERE DB_ALCP_CODIGO IN (
SELECT DB_ALCP_CODIGO
FROM DB_ALCADA_PED
WHERE DBO.MERCF_VALIDA_LISTA(@V_CLI_RAMATIV,	 DB_ALCP_LSTRAMO,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_EMPRESA,	 DB_ALCP_LSTEMP,    0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_TIPO,		 DB_ALCP_LSTTIPO,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_CLI_CLASCOM,	 DB_ALCP_LSTCLASS,  0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_SITCORP,	 DB_ALCP_LSTSITCORP,0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_CLI_REGIAOCOM,  DB_ALCP_LSTREGCOM, 0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_OPERACAO,	 DB_ALCP_LSTOPER,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_STATUS_PED_ATUAL, DB_ALCP_LSTSTATUS,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_DB_PED_LISTA_PRECO, DB_ALCP_LSTLISTAPRECO,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_CLI_AREAATU,	 DB_ALCP_LSTAREAATU,   0, ',') > 0
AND CASE WHEN ISNULL(DB_ALCP_OPCREP, 0) = 0 AND 0 = 0
THEN 1
WHEN ISNULL(DB_ALCP_OPCREP, 0) = 1 AND DBO.MERCF_VALIDA_LISTA(@V_PED_REPRES, DB_ALCP_LSTREP, 0, ',') > 0
THEN 1
WHEN ISNULL(DB_ALCP_OPCREP, 0) = 2 AND DBO.MERCF_VALIDA_LISTA(@V_PED_REPRES, DB_ALCP_LSTREP, 1, ',') > 0
THEN 1
ELSE 0
END = 1
AND ((@V_PED_REPRES IN (SELECT Z.DB_EREG_REPRES
FROM DB_ESTRUT_VENDA X,
DB_ESTRUT_VENDA Y,
DB_ESTRUT_REGRA Z,
DB_ESTRUT_REGRA Z1,
DB_ALCADA_ESTRUT AL
WHERE X.DB_EVDA_ESTRUTURA  = Y.DB_EVDA_ESTRUTURA
AND Y.DB_EVDA_CODIGO     LIKE (X.DB_EVDA_CODIGO + '%')
AND X.DB_EVDA_ESTRUTURA  = Z.DB_EREG_ESTRUTURA
AND Y.DB_EVDA_ID         = Z.DB_EREG_ID
AND X.DB_EVDA_ESTRUTURA  = Z1.DB_EREG_ESTRUTURA
AND X.DB_EVDA_ID         = Z1.DB_EREG_ID
AND AL.DB_ALCE_ESTRUTURA = Z1.DB_EREG_ESTRUTURA
AND DB_ALCP_CODIGO       = AL.DB_ALCE_ALCADA
AND AL.DB_ALCE_ID        =  Z1.DB_EREG_ID ) )    OR ((SELECT TOP(1) DB_ALCE_ALCADA
FROM DB_ALCADA_ESTRUT
WHERE DB_ALCP_CODIGO = DB_ALCE_ALCADA) IS NULL))
/*
AND (EXISTS (SELECT 1
FROM DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PEDIDO = @P_NRO
AND DB_PROD_CODIGO = DB_PEDI_PRODUTO
AND DBO.MERCF_VALIDA_LISTA(DB_PROD_TPPROD, DB_ALCP_LSTTPPROD, 0, ',') > 0)
OR DB_ALCP_LSTTPPROD IS NULL)*/
AND (EXISTS (SELECT 1
FROM DB_PEDIDO, DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PEDIDO     = @P_NRO
AND DB_PEDI_PEDIDO     = DB_PED_NRO
AND DB_PROD_CODIGO     = DB_PEDI_PRODUTO
AND ( ((DB_PED_MOTIVO_BLOQ LIKE '%D%' AND (NOT DB_ALCP_MOTBLOQ LIKE '%D%' OR (DB_ALCP_MOTBLOQ LIKE '%D%' AND DB_PEDI_ECON_VLR < 0)))
OR DB_PED_MOTIVO_BLOQ NOT LIKE '%D%')
OR ((DB_PED_MOTIVO_BLOQ LIKE '%F%' AND (NOT DB_ALCP_MOTBLOQ LIKE '%F%' OR (DB_ALCP_MOTBLOQ LIKE '%F%' AND (DB_PEDI_TIPO = 'B' OR DB_PED_FATUR = 2))))
OR DB_PED_MOTIVO_BLOQ NOT LIKE '%F%')
)
AND DB_ALCP_LSTTPPROD LIKE '%' + DB_PROD_TPPROD + '%')
OR ISNULL(DB_ALCP_LSTTPPROD,'') = '')
AND (EXISTS(
SELECT DOCUMENTO
FROM DB_PEDIDO_DOC_BLOQ
WHERE PEDIDO = @P_NRO
AND ISNULL(DATA_LIBERACAO, '') = ''
AND (ISNULL(DB_ALCP_LSTTIPODOC , '') LIKE  CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR) + ',%' OR  ISNULL(DB_ALCP_LSTTIPODOC , '') LIKE '%,' + CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR) + ',%' OR  ISNULL(DB_ALCP_LSTTIPODOC , '') LIKE  '%,' + CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR)
OR ISNULL(DB_ALCP_LSTTIPODOC , '') = CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR) OR ISNULL(ISNULL(DB_ALCP_LSTTIPODOC , ''), '') = ''))
OR ISNULL(DB_ALCP_LSTTIPODOC, '')  = ''
OR (SELECT TOP 1 1 FROM DB_PEDIDO_DOC_BLOQ WHERE PEDIDO = @P_NRO AND ISNULL(DATA_LIBERACAO, '') = '') IS NULL)
AND (CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,1,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,2,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,3,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,4,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,5,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,6,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,7,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,8,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,9,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,10,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,11,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,12,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,13,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,14,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADO,15,1), DB_ALCP_MOTBLOQ) > 0)
AND ( DB_ALCP_GRPALCADA = @V_ALCP_GRPALCADA_ANTERIOR OR ISNULL(@V_ALCP_GRPALCADA_ANTERIOR, '') = '')
AND (((DB_ALCP_GRUPOLIB = @V_ALCP_GRPLIB_ANTERIOR AND DB_ALCP_NIVELLIB > @V_ALCP_NIVLIB_ANTERIOR)
OR (DB_ALCP_GRUPOLIB > @V_ALCP_GRPLIB_ANTERIOR))
OR ISNULL(@V_ALCP_CODIGO_ANTERIOR, '') = '')
AND DB_ALCP_CODIGO NOT IN ( SELECT DB_ALCP_CODIGO
FROM DB_ALCADA_PED A, DB_PEDIDO_ALCADA B
WHERE DB_ALCP_CODIGO = DB_PEDAL_ALCADA
AND DB_PEDAL_PEDIDO = @P_NRO)
AND DB_ALCP_TIPO = 0
)
ORDER BY DB_ALCP_GRPALCADA, DB_ALCP_GRUPOLIB, DB_ALCP_NIVELLIB
OPEN C
FETCH NEXT FROM C
INTO @V_ALCP_CODIGO_TEMP
BEGIN
IF @V_ALCP_CODIGO IS NULL
SET @V_ALCP_CODIGO = @V_ALCP_CODIGO_TEMP;
END
FETCH NEXT FROM C
INTO @V_ALCP_CODIGO_TEMP
END
CLOSE C
DEALLOCATE C
IF ISNULL(@V_ALCP_CODIGO, '') <> ''
BEGIN
INSERT INTO DB_PEDIDO_ALCADA(DB_PEDAL_PEDIDO, DB_PEDAL_SEQ, DB_PEDAL_ALCADA, DB_PEDAL_STATUS)
VALUES
(@P_NRO, CONVERT(NUMERIC(30),ISNULL(@V_PEDAL_SEQ, 0) + 1), @V_ALCP_CODIGO, 0);
SET @V_ENV_WORKFLOW = 18;
SET @V_STATUS_PED = 0;
SELECT @V_STATUS_PED = DB_ALCP_STATUS_ALCADA
FROM DB_ALCADA_PED, DB_STATUS
WHERE DB_ALCP_CODIGO = @V_ALCP_CODIGO
AND DB_ALCP_STATUS_ALCADA = DB_STATUS.CODIGO
AND GETDATE() BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_PED <> 0 AND ISNULL(@V_STATUS_PED, '') <> ''
BEGIN
IF @V_STATUS_PED <> @V_STATUS_PED_ATUAL
BEGIN
INSERT INTO DB_MENSAGEM (
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_PEDIDO,
DB_MSG_TEXTO)
VALUES (
@V_PED_REPRES,
ISNULL((SELECT MAX(DB_MSG_SEQUENCIA) FROM DB_MENSAGEM WHERE DB_MSG_REPRES = @V_PED_REPRES), 0) + 1,
GETDATE(),
@P_USUARIO,
@P_NRO,
'Liberação de pedido: novo status do pedido: ' +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED), '[SEM STATUS]') +
'. Status anterior: '  +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED_ATUAL), '[SEM STATUS]')
);
END
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = @V_STATUS_PED
WHERE DB_PEDC_NRO = @P_NRO;
END
ELSE
BEGIN
IF @V_STATUS_PED_ATUAL <> 0 AND ISNULL(@V_STATUS_PED_ATUAL, '') <> ''
BEGIN
SET @V_STATUS_VALIDO = 0;
SELECT @V_STATUS_VALIDO = 1
FROM DB_STATUS
WHERE DB_STATUS.CODIGO = @V_STATUS_PED_ATUAL
AND CAST(GETDATE() AS DATE) BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_VALIDO = 0
BEGIN
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = 0
WHERE DB_PEDC_NRO = @P_NRO;
END
END
END
END
END
END
END
ELSE
BEGIN
SET @V_PASSO = '29';
BEGIN
SET @V_ALCP_GRPALCADA_ANTERIOR = NULL;
SET @V_ALCP_CODIGO_ANTERIOR = NULL;
SET @V_ALCP_GRPLIB_ANTERIOR = NULL;
SET @V_ALCP_NIVLIB_ANTERIOR = NULL;
SELECT  @V_ALCP_GRPALCADA_ANTERIOR = DB_ALCP_GRPALCADA,
@V_ALCP_CODIGO_ANTERIOR = DB_ALCP_CODIGO,
@V_ALCP_GRPLIB_ANTERIOR = DB_ALCP_GRUPOLIB,
@V_ALCP_NIVLIB_ANTERIOR = DB_ALCP_NIVELLIB
FROM DB_ALCADA_PED A, DB_PEDIDO_ALCADA B
WHERE DB_ALCP_CODIGO = DB_PEDAL_ALCADA
AND DB_PEDAL_PEDIDO = @P_NRO
AND DB_PEDAL_SEQ = (SELECT MAX(DB_PEDAL_SEQ) FROM DB_PEDIDO_ALCADA WHERE DB_PEDAL_PEDIDO = @P_NRO)
END
SET @V_PASSO = 30;
SET @V_AUX = 0
SET @V_MOTNLIBERADO = ''
IF ISNULL(@V_MOTIVOS, '') <> ''
BEGIN
IF ISNULL(@V_BLOQUEIOS, '') = ''
SET @V_MOTNLIBERADO = @V_MOTIVOS;
WHILE @V_AUX < LEN(@V_MOTIVOS)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTIVOS, @V_AUX, 1), (@V_BLOQUEIOS)) = 0
SET @V_MOTNLIBERADO = @V_MOTNLIBERADO + SUBSTRING(@V_MOTIVOS, @V_AUX, 1);
END
END
SET @V_AUX = 0;
IF ISNULL(@V_MOTNLIBERADO, '') <> ''
SET @V_ACHOU_OUTROMOTIVO = 0
BEGIN
WHILE @V_AUX < LEN(@V_MOTNLIBERADO)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF RTRIM(LTRIM(SUBSTRING(@V_MOTNLIBERADO, @V_AUX, 1))) IS NOT NULL
IF CHARINDEX(SUBSTRING(@V_MOTNLIBERADO, @V_AUX, 1), ISNULL(@V_PARAM_MOTIVSLIBER, ' ')) = 0
SET @V_ACHOU_OUTROMOTIVO = 1;
END
END
IF @V_ACHOU_OUTROMOTIVO = 0
BEGIN
INSERT INTO DB_PEDIDO_ALCADA
(DB_PEDAL_PEDIDO,
DB_PEDAL_SEQ,
DB_PEDAL_STATUS,
DB_PEDAL_MOTLIB,
DB_PEDAL_DATALIB)
VALUES
(@P_NRO, 1, 1, @V_MOTNLIBERADO, GETDATE());
UPDATE DB_PEDIDO
SET DB_PED_SITUACAO = 0
WHERE DB_PED_NRO = @P_NRO;
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_CODINTEGR = 0
WHERE DB_PEDC_NRO = @P_NRO;
IF ISNULL(@P_OBSERVACAOJUSTIFICATIVA, '') = ''
SET @V_DESCRICAO = @V_PROGRAMA + ' Liberou pedido total. Pedido nro: ' + CAST(@P_NRO AS VARCHAR);
ELSE
BEGIN
SET @V_DESCRICAO = @V_PROGRAMA + ' Liberou pedido total com justificativa. Pedido nro: ' + CAST(@P_NRO AS VARCHAR);
IF @VLIB_GRAVAJUSTIFICATIVAPED = 1
BEGIN
INSERT INTO DB_MENSAGEM (DB_MSG_TEXTO,
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_MOTIVO,
DB_MSG_PEDIDO,
DB_MSG_TIPO)
VALUES(
'Motivo ' + ISNULL(@V_MOTNLIBERADO, '') + ': ' + isnull(@P_OBSERVACAOJUSTIFICATIVA, ''),
@V_PED_REPRES,
(SELECT ISNULL(MAX(DB_MSG_SEQUENCIA), 0) + 1 FROM DB_MENSAGEM),
GETDATE(),
@P_USUARIO,
1,
@P_NRO,
5
)
END
END
SET @V_ENV_WORKFLOW = 19;
END
ELSE
BEGIN
SET @V_AUX = 0;
PRINT 'ELSE'
PRINT '1@V_MOTIVOS = ' + ISNULL(@V_MOTIVOS, 'NULL')
PRINT '1@V_MOTNLIBERADO = ' + ISNULL(@V_MOTNLIBERADO, 'NULL')
SET @V_MOTNLIBERADOSALVARPEDIDO = '';
SET @V_AUX = 0;
IF ISNULL(@V_PARAM_MOTIVSLIBER, '') <> ''
BEGIN
WHILE @V_AUX < LEN(@V_MOTNLIBERADO)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF CHARINDEX(SUBSTRING(@V_MOTNLIBERADO, @V_AUX, 1), (@V_PARAM_MOTIVSLIBER)) = 0
SET @V_MOTNLIBERADOSALVARPEDIDO  = @V_MOTNLIBERADOSALVARPEDIDO + SUBSTRING(@V_MOTNLIBERADO, @V_AUX, 1);
END
END
ELSE
BEGIN
SET @V_MOTNLIBERADOSALVARPEDIDO = @V_MOTNLIBERADO;
END
BEGIN
DECLARE C CURSOR
FOR SELECT DB_ALCP_CODIGO
FROM DB_ALCADA_PED
WHERE DB_ALCP_CODIGO IN (
SELECT DB_ALCP_CODIGO
FROM DB_ALCADA_PED
WHERE DBO.MERCF_VALIDA_LISTA(@V_CLI_RAMATIV,	 DB_ALCP_LSTRAMO,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_EMPRESA,	 DB_ALCP_LSTEMP,    0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_TIPO,		 DB_ALCP_LSTTIPO,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_CLI_CLASCOM,	 DB_ALCP_LSTCLASS,  0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_SITCORP,	 DB_ALCP_LSTSITCORP,0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_CLI_REGIAOCOM,  DB_ALCP_LSTREGCOM, 0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_PED_OPERACAO,	 DB_ALCP_LSTOPER,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_STATUS_PED_ATUAL, DB_ALCP_LSTSTATUS,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_DB_PED_LISTA_PRECO, DB_ALCP_LSTLISTAPRECO,   0, ',') > 0
AND DBO.MERCF_VALIDA_LISTA(@V_CLI_AREAATU,	 DB_ALCP_LSTAREAATU,   0, ',') > 0
AND CASE WHEN ISNULL(DB_ALCP_OPCREP, 0) = 0 AND 0 = 0
THEN 1
WHEN ISNULL(DB_ALCP_OPCREP, 0) = 1 AND DBO.MERCF_VALIDA_LISTA(@V_PED_REPRES, DB_ALCP_LSTREP, 0, ',') > 0
THEN 1
WHEN ISNULL(DB_ALCP_OPCREP, 0) = 2 AND DBO.MERCF_VALIDA_LISTA(@V_PED_REPRES, DB_ALCP_LSTREP, 1, ',') > 0
THEN 1
ELSE 0
END = 1
AND ((@V_PED_REPRES IN (SELECT Z.DB_EREG_REPRES
FROM DB_ESTRUT_VENDA X,
DB_ESTRUT_VENDA Y,
DB_ESTRUT_REGRA Z,
DB_ESTRUT_REGRA Z1,
DB_ALCADA_ESTRUT AL
WHERE X.DB_EVDA_ESTRUTURA  = Y.DB_EVDA_ESTRUTURA
AND Y.DB_EVDA_CODIGO     LIKE (X.DB_EVDA_CODIGO + '%')
AND X.DB_EVDA_ESTRUTURA  = Z.DB_EREG_ESTRUTURA
AND Y.DB_EVDA_ID         = Z.DB_EREG_ID
AND X.DB_EVDA_ESTRUTURA  = Z1.DB_EREG_ESTRUTURA
AND X.DB_EVDA_ID         = Z1.DB_EREG_ID
AND AL.DB_ALCE_ESTRUTURA = Z1.DB_EREG_ESTRUTURA
AND DB_ALCP_CODIGO       = AL.DB_ALCE_ALCADA
AND AL.DB_ALCE_ID        =  Z1.DB_EREG_ID ))  OR ((SELECT TOP(1) DB_ALCE_ALCADA
FROM DB_ALCADA_ESTRUT
WHERE DB_ALCP_CODIGO = DB_ALCE_ALCADA) IS NULL))
/*AND (EXISTS (SELECT 1
FROM DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PEDIDO = @P_NRO
AND DB_PROD_CODIGO = DB_PEDI_PRODUTO
AND DBO.MERCF_VALIDA_LISTA(DB_PROD_TPPROD, DB_ALCP_LSTTPPROD, 0, ',') > 0)
OR DB_ALCP_LSTTPPROD IS NULL)*/
AND (EXISTS (SELECT 1
FROM DB_PEDIDO, DB_PEDIDO_PROD, DB_PRODUTO
WHERE DB_PEDI_PEDIDO     = @P_NRO
AND DB_PEDI_PEDIDO     = DB_PED_NRO
AND DB_PROD_CODIGO     = DB_PEDI_PRODUTO
AND ( ((DB_PED_MOTIVO_BLOQ LIKE '%D%' AND (NOT DB_ALCP_MOTBLOQ LIKE '%D%' OR (DB_ALCP_MOTBLOQ LIKE '%D%' AND DB_PEDI_ECON_VLR < 0)))
OR DB_PED_MOTIVO_BLOQ NOT LIKE '%D%')
OR ((DB_PED_MOTIVO_BLOQ LIKE '%F%' AND (NOT DB_ALCP_MOTBLOQ LIKE '%F%' OR (DB_ALCP_MOTBLOQ LIKE '%F%' AND (DB_PEDI_TIPO = 'B' OR DB_PED_FATUR = 2))))
OR DB_PED_MOTIVO_BLOQ NOT LIKE '%F%')
)
AND DB_ALCP_LSTTPPROD LIKE '%' + DB_PROD_TPPROD + '%')
OR ISNULL(DB_ALCP_LSTTPPROD,'') = '')
AND (EXISTS(
SELECT DOCUMENTO
FROM DB_PEDIDO_DOC_BLOQ
WHERE PEDIDO = @P_NRO
AND ISNULL(DATA_LIBERACAO, '') = ''
AND (ISNULL(DB_ALCP_LSTTIPODOC , '') LIKE  CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR) + ',%' OR  ISNULL(DB_ALCP_LSTTIPODOC , '') LIKE '%,' + CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR) + ',%' OR  ISNULL(DB_ALCP_LSTTIPODOC , '') LIKE  '%,' + CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR)
OR ISNULL(DB_ALCP_LSTTIPODOC , '') = CAST(CAST(DOCUMENTO  AS VARCHAR) AS VARCHAR) OR ISNULL(ISNULL(DB_ALCP_LSTTIPODOC , ''), '') = ''))
OR ISNULL(DB_ALCP_LSTTIPODOC, '')  = ''
OR (SELECT TOP 1 1 FROM DB_PEDIDO_DOC_BLOQ WHERE PEDIDO = @P_NRO AND ISNULL(DATA_LIBERACAO, '') = '') IS NULL)
AND (CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,1,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,2,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,3,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,4,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,5,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,6,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,7,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,8,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,9,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,10,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,11,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,12,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,13,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,14,1), DB_ALCP_MOTBLOQ) > 0
OR  CHARINDEX(SUBSTRING(@V_MOTNLIBERADOSALVARPEDIDO,15,1), DB_ALCP_MOTBLOQ) > 0)
AND ( DB_ALCP_GRPALCADA = @V_ALCP_GRPALCADA_ANTERIOR OR ISNULL(@V_ALCP_GRPALCADA_ANTERIOR, '') = '')
AND (((DB_ALCP_GRUPOLIB = @V_ALCP_GRPLIB_ANTERIOR AND DB_ALCP_NIVELLIB > @V_ALCP_NIVLIB_ANTERIOR)
OR (DB_ALCP_GRUPOLIB > @V_ALCP_GRPLIB_ANTERIOR))
OR ISNULL(@V_ALCP_CODIGO_ANTERIOR, '') = '')
AND DB_ALCP_CODIGO NOT IN ( SELECT DB_ALCP_CODIGO
FROM DB_ALCADA_PED A, DB_PEDIDO_ALCADA B
WHERE DB_ALCP_CODIGO = DB_PEDAL_ALCADA
AND DB_PEDAL_PEDIDO = @P_NRO)
AND DB_ALCP_TIPO = 0
)
ORDER BY DB_ALCP_GRPALCADA, DB_ALCP_GRUPOLIB, DB_ALCP_NIVELLIB
OPEN C
FETCH NEXT FROM C
INTO @V_ALCP_CODIGO_TEMP
BEGIN
IF @V_ALCP_CODIGO IS NULL
SET @V_ALCP_CODIGO = @V_ALCP_CODIGO_TEMP;
END
FETCH NEXT FROM C
INTO @V_ALCP_CODIGO_TEMP
END
CLOSE C
DEALLOCATE C
IF @V_GRAVALOG = 1
BEGIN
IF ISNULL(@V_ALCP_CODIGO, '') = ''
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR) + ' Nao encontrou alcada valida');
END
else
BEGIN
INSERT INTO DBS_ERROS_TRIGGERS
(DBS_ERROS_OBJETO, DBS_ERROS_DATA, DBS_ERROS_ERRO)
VALUES
('MERCP_LIBERCAO_PEDIDO_LOG', GETDATE(), 'Pedido: ' + CAST(@P_NRO AS VARCHAR) + ' - Usu: ' + ISNULL(@P_USUARIO, 'null') + ' - acao: ' + CAST(@P_ACAO AS VARCHAR) + ' - exclui: ' + CAST(@P_EXCLUI AS VARCHAR)
+ ' Busca alcada - ' + ISNULL(@V_MOTNLIBERADO, 'null') + ' - alcada: ' + @V_ALCP_CODIGO);
END
END
IF @P_ACAO = 2
BEGIN
SET @V_ULTIMO_GRUPO = NULL;
SET @V_GRUPO_ATUAL = NULL;
SELECT @V_ULTIMO_GRUPO = MAX(DB_ALCP_GRUPOLIB)
FROM DB_ALCADA_PED A, DB_PEDIDO_ALCADA B
WHERE DB_ALCP_CODIGO = DB_PEDAL_ALCADA
AND DB_PEDAL_PEDIDO = @P_NRO;
SELECT @V_GRUPO_ATUAL = DB_ALCP_GRUPOLIB
FROM DB_ALCADA_PED
WHERE DB_ALCP_CODIGO = @V_ALCP_CODIGO
IF ISNULL(@V_ULTIMO_GRUPO, '') <> ISNULL(@V_GRUPO_ATUAL, '')
BEGIN
SET @V_PERMITE_ENCAMINHAR = 1;
SET @VERRO = 'PEDIDO '+ CONVERT(VARCHAR, @P_NRO) + ' - NAO FOI POSSIVEL ENCAMINHAR PARA SUPERIOR, POIS USUARIO: ' + @P_USUARIO + ' E O ULTIMO DA HIERARQUIA.';
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, GETDATE(), @VOBJETO);
END
ELSE
BEGIN
SET @V_PERMITE_ENCAMINHAR = 0;
END
END
ELSE
BEGIN
SET @V_PERMITE_ENCAMINHAR = 0;
END
IF @V_PERMITE_ENCAMINHAR = 0
BEGIN
SET @V_PASSO = '31';
BEGIN
SET @V_EXISTE = 0;
SELECT @V_EXISTE = 1
FROM DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO
END
IF @P_EXCLUI = 0
BEGIN
UPDATE DB_PEDIDO
SET DB_PED_LIB_MOTS = ISNULL(DB_PED_LIB_MOTS, '') + ';'
, DB_PED_LIB_USUS = ISNULL(DB_PED_LIB_USUS, '') + @P_USUARIO + '!' + CONVERT(VARCHAR, @V_GRUPO_LIB) + ';'
, DB_PED_LIB_DATAS = ISNULL(DB_PED_LIB_DATAS, '') + CONVERT(VARCHAR, GETDATE(), 103) + ';'
, DB_PED_DATA_ALTER = GETDATE()
WHERE DB_PED_NRO = @P_NRO;
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_LIB_HORAS  = ISNULL(DB_PEDC_LIB_HORAS, '') + CONVERT(VARCHAR, GETDATE(), 108) + ';'
, DB_PEDC_DTULTLIB   = GETDATE()
WHERE DB_PEDC_NRO  = @P_NRO;
END
PRINT 'NA FASE FINAL'
PRINT '@V_MOTIVOS ' + @V_MOTIVOS
PRINT'@V_MOTNLIBERADO ' + @V_MOTNLIBERADO
PRINT '@V_BLOQUEIOS ' + @V_BLOQUEIOS
PRINT '@V_PERMI ' + @V_PERMI
SET @V_AUX = 0
IF ISNULL(@V_PERMI, '') <> ''
BEGIN
WHILE @V_AUX < LEN(@V_PERMI)
BEGIN
SET @V_AUX = @V_AUX + 1;
IF  CHARINDEX(SUBSTRING(@V_PERMI, @V_AUX, 1), ISNULL(@V_MOTIVOS, ' ')) > 0
SET @V_PEDAL_MOTLIBPAR = ISNULL(@V_PEDAL_MOTLIBPAR, '') + SUBSTRING(@V_PERMI, @V_AUX, 1);
END
END
IF ISNULL(@V_EXISTE, 0) = 0
BEGIN
IF ISNULL(@V_ALCP_CODIGO, '') <> ''
BEGIN
INSERT INTO DB_PEDIDO_ALCADA(DB_PEDAL_PEDIDO, DB_PEDAL_SEQ, DB_PEDAL_ALCADA, DB_PEDAL_STATUS)
VALUES (@P_NRO, ISNULL(@V_PEDAL_SEQ, 0) + 1, @V_ALCP_CODIGO, 0);
SET @V_ENV_WORKFLOW = 18;
SET @V_STATUS_PED = 0;
SELECT @V_STATUS_PED = DB_ALCP_STATUS_ALCADA
FROM DB_ALCADA_PED, DB_STATUS
WHERE DB_ALCP_CODIGO = @V_ALCP_CODIGO
AND DB_ALCP_STATUS_ALCADA = DB_STATUS.CODIGO
AND GETDATE() BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_PED <> 0 AND ISNULL(@V_STATUS_PED, '') <> ''
BEGIN
IF @V_STATUS_PED <> @V_STATUS_PED_ATUAL
BEGIN
INSERT INTO DB_MENSAGEM (
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_PEDIDO,
DB_MSG_TEXTO)
VALUES (
@V_PED_REPRES,
ISNULL((SELECT MAX(DB_MSG_SEQUENCIA) FROM DB_MENSAGEM WHERE DB_MSG_REPRES = @V_PED_REPRES), 0) + 1,
GETDATE(),
@P_USUARIO,
@P_NRO,
'Liberação de pedido: novo status do pedido: ' +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED), '[SEM STATUS]') +
'. Status anterior: '  +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED_ATUAL), '[SEM STATUS]')
);
END
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = @V_STATUS_PED
WHERE DB_PEDC_NRO = @P_NRO;
END
ELSE
BEGIN
IF @V_STATUS_PED_ATUAL <> 0 AND ISNULL(@V_STATUS_PED_ATUAL, '') <> ''
BEGIN
SET @V_STATUS_VALIDO = 0;
SELECT @V_STATUS_VALIDO = 1
FROM DB_STATUS
WHERE DB_STATUS.CODIGO = @V_STATUS_PED_ATUAL
AND CAST(GETDATE() AS DATE) BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_VALIDO = 0
BEGIN
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = 0
WHERE DB_PEDC_NRO = @P_NRO;
END
END
END
END
END
ELSE
BEGIN
SELECT @V_PEDAL_SEQ = MAX(DB_PEDAL_SEQ)
FROM DB_PEDIDO_ALCADA
WHERE DB_PEDAL_PEDIDO = @P_NRO;
UPDATE DB_PEDIDO_ALCADA
SET DB_PEDAL_USULIB   = @V_CODIGO_USUARIO
, DB_PEDAL_DATALIB  = GETDATE()
, DB_PEDAL_ACAO     = @P_ACAO
, DB_PEDAL_STATUS   = 2
, DB_PEDAL_JUSTIF  = @P_CODIGOJUSTIFICATIVA
, DB_PEDAL_JUSTOBS = @P_OBSERVACAOJUSTIFICATIVA
, DB_PEDAL_JREPRES = @P_REPRESJUSTIFICATIVA
, DB_PEDAL_MOTLIBPAR = @V_PEDAL_MOTLIBPAR
WHERE DB_PEDAL_PEDIDO   = @P_NRO
AND DB_PEDAL_SEQ      = @V_PEDAL_SEQ;
IF @P_ACAO = 2
BEGIN
INSERT INTO DB_PEDIDO_ALCADA(DB_PEDAL_PEDIDO, DB_PEDAL_SEQ, DB_PEDAL_ALCADA, DB_PEDAL_STATUS)
VALUES (@P_NRO, ISNULL(@V_PEDAL_SEQ, 0) + 1, @V_ALCP_CODIGO, 0);
IF @VLIB_GRAVAJUSTIFICATIVAPED = 1 AND ISNULL(@P_OBSERVACAOJUSTIFICATIVA, '') <> ''
BEGIN
INSERT INTO DB_MENSAGEM (DB_MSG_TEXTO,
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_MOTIVO,
DB_MSG_PEDIDO,
DB_MSG_TIPO)
VALUES(
'Motivo ' + ISNULL(@V_PEDAL_MOTLIBPAR, '') + ': ' + @P_OBSERVACAOJUSTIFICATIVA,
@V_PED_REPRES,
(SELECT ISNULL(MAX(DB_MSG_SEQUENCIA), 0) + 1 FROM DB_MENSAGEM),
GETDATE(),
@P_USUARIO,
1,
@P_NRO,
5
)
END
SET @V_ENV_WORKFLOW = 18;
SET @V_STATUS_PED = 0;
SELECT @V_STATUS_PED = DB_ALCP_STATUS_ALCADA
FROM DB_ALCADA_PED, DB_STATUS
WHERE DB_ALCP_CODIGO = @V_ALCP_CODIGO
AND DB_ALCP_STATUS_ALCADA = DB_STATUS.CODIGO
AND GETDATE() BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_PED <> 0 AND ISNULL(@V_STATUS_PED, '') <> ''
BEGIN
IF @V_STATUS_PED <> @V_STATUS_PED_ATUAL
BEGIN
INSERT INTO DB_MENSAGEM (
DB_MSG_REPRES,
DB_MSG_SEQUENCIA,
DB_MSG_DATA,
DB_MSG_USU_ENVIO,
DB_MSG_PEDIDO,
DB_MSG_TEXTO)
VALUES (
@V_PED_REPRES,
ISNULL((SELECT MAX(DB_MSG_SEQUENCIA) FROM DB_MENSAGEM WHERE DB_MSG_REPRES = @V_PED_REPRES), 0) + 1,
GETDATE(),
@P_USUARIO,
@P_NRO,
'Liberação de pedido: novo status do pedido: ' +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED), '[SEM STATUS]') +
'. Status anterior: '  +
ISNULL((SELECT DESCRICAO FROM DB_STATUS WHERE CODIGO = @V_STATUS_PED_ATUAL), '[SEM STATUS]')
);
END
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = @V_STATUS_PED
WHERE DB_PEDC_NRO = @P_NRO;
END
ELSE
BEGIN
IF @V_STATUS_PED_ATUAL <> 0 AND ISNULL(@V_STATUS_PED_ATUAL, '') <> ''
BEGIN
SET @V_STATUS_VALIDO = 0;
SELECT @V_STATUS_VALIDO = 1
FROM DB_STATUS
WHERE DB_STATUS.CODIGO = @V_STATUS_PED_ATUAL
AND CAST(GETDATE() AS DATE) BETWEEN DATA_INICIAL AND DATA_FINAL;
IF @V_STATUS_VALIDO = 0
BEGIN
UPDATE DB_PEDIDO_COMPL
SET DB_PEDC_STATUSPED = 0
WHERE DB_PEDC_NRO = @P_NRO;
END
END
END
END
SET @V_DESCRICAO = @V_PROGRAMA + ' ENCAMINHOU PEDIDO PARA SUPERIOR. PEDIDO NRO: ' + CAST(@P_NRO AS VARCHAR);
END
SET @V_PASSO = 32;
END
END
END
END
IF (@V_PERMITE_LOG = 1)
BEGIN
IF ISNULL(@P_USUARIO, '') = ''
BEGIN
SET @V_USUARIO_PARA_LOG = 'SEM USUÁRIO'
END
ELSE
BEGIN
SET @V_USUARIO_PARA_LOG = @P_USUARIO
END
SET @V_COMPLEMENTO_LOG = SUBSTRING(' (' + CAST( @P_NRO AS VARCHAR)
+ '-' + CAST( @P_EXCLUI AS VARCHAR)
+ '-' + @V_USUARIO_PARA_LOG
+ '-' + CAST( @P_ACAO AS VARCHAR)
+ '-' + ISNULL(@P_CODIGOJUSTIFICATIVA, 'NULL')
+ '-' + ISNULL(@P_OBSERVACAOJUSTIFICATIVA, 'NULL')
+ '-' + CAST( ISNULL(@P_REPRESJUSTIFICATIVA, 0) AS VARCHAR) + ')', 1, 800)
IF @V_PED_WEB = 1
BEGIN
INSERT INTO MSL1
(SL1_DATA,
SL1_USUARIO,
SL1_MENU,
SL1_ITEM_MENUWEB,
SL1_ACAO,
SL1_DESCRICAO)
VALUES
(GETDATE(), @V_USUARIO_PARA_LOG, 0, 'Liberação de pedidos', 4, isnull(@V_DESCRICAO, '')  + '  ' + RTRIM(LTRIM(@V_COMPLEMENTO_LOG)));
END
ELSE
BEGIN
INSERT INTO MSL1
(SL1_DATA,
SL1_USUARIO,
SL1_MENU,
SL1_MENUITEM,
SL1_ACAO,
SL1_DESCRICAO)
VALUES
(GETDATE(), @V_USUARIO_PARA_LOG, 0, 'Liberação de pedidos', 4, isnull(@V_DESCRICAO, '')  + '  ' + RTRIM(LTRIM(@V_COMPLEMENTO_LOG)));
END
END
IF @V_ENV_WORKFLOW > 0
BEGIN
SET @V_PASSO = '33';
EXEC MERCP_WORKFLOW @V_ENV_WORKFLOW,
@V_PED_CLIENTE,
@P_NRO,
@V_PED_EMPRESA,
NULL,
NULL,
NULL,
NULL,
@P_USUARIO,
@VRETORNO;
END
COMMIT
END TRY
BEGIN CATCH
ROLLBACK
SET @VDATA = GETDATE();
SET @VERRO = 'ERRO AO LIBERAR O PEDIDO :' + CONVERT(VARCHAR, @P_NRO) + ' -PASSO:' + @V_PASSO + ' ' + ERROR_MESSAGE();
INSERT INTO DBS_ERROS_TRIGGERS (DBS_ERROS_ERRO, DBS_ERROS_DATA, DBS_ERROS_OBJETO) VALUES (@VERRO, @VDATA, @VOBJETO);
END CATCH
END
GO
